<!DOCTYPE html>
<html lang="en" x-data="app()" x-init="initializeAlpineApp()" x-cloak>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Staff Rota & Tasks</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Alpine.js for interactivity -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Define and register the Alpine component -->
  <script>
    function app() {
      return {
        // --- Data Properties (Reactive) ---
        staff: [],
        user: null, // Logged-in user object { name: '', role: '', icon: '' }
        view: 'home', // Current active view ('home', 'tasks', 'rota', 'calendar', 'admin', 'landing')

        // Core App Data (synced with localStorage)
        rota: {}, // { 'YYYY-MM-DD': { 'Staff Name': 'Shift Type' } }
        dailyTasks: {}, // { 'YYYY-MM-DD': { 'Staff Name': ['Task 1', 'Task 2'] } }
        completedTasks: {}, // { 'YYYY-MM-DD': { 'Staff Name': { 'Task Name': {timestamp: ts, imageName: 'file.jpg'} } } }
        clockIns: {}, // { 'YYYY-MM-DD': { 'Staff Name': { 'in': timestamp, 'out': timestamp | null } } }
        messageBoard: [], // [{ sender: 'Name', text: 'Message', timestamp: 123456789 }]

        // UI State for Forms/Views
        isAdminMode: false,
        currentCalendarDate: new Date(), // For calendar view
        calendarRoleFilter: 'all', // Filter for calendar view

        // Form data for Admin Panel
        shiftForm: { staffName: '', date: '', type: '', customType: '', repeatDays: 1 },
        taskForm: { staffName: '', date: '', description: '', customDescription: '', repeatDays: 1 },

        // Data for admin view lists
        assignedShiftsView: { staffName: '', date: '' },
        assignedShifts: [],
        assignedTasksView: { staffName: '', date: '' },
        assignedTasks: [],
        attendanceView: { date: '' },
        attendanceList: [],
        taskOverviewView: { date: '', statusFilter: 'all' },
        taskOverviewList: [],

        newMessageText: '', // For message board input

        // --- Computed Properties ---
        get todayFormatted() {
          return this.getFormattedDate(new Date());
        },
        get currentDayInfo() {
          return this.getDisplayDate(new Date());
        },
        get currentCalendarMonthYear() {
          return this.currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        },
        get isClockedIn() {
          const data = this.clockIns[this.todayFormatted]?.[this.user?.name];
          return data && data.in && !data.out;
        },
        get clockStatusMessage() {
          if (!this.user) return 'Please log in.';
          const data = this.clockIns[this.todayFormatted]?.[this.user.name];
          if (data?.in && !data.out) {
            return `You are clocked in since ${this.formatTimestampToTime(data.in)}`;
          } else if (data?.in && data.out) {
            return `Clocked in: ${this.formatTimestampToTime(data.in)}, Clocked out: ${this.formatTimestampToTime(data.out)}`;
          } else {
            return 'You are not clocked in for today.';
          }
        },
        get clockButtonText() {
          return this.isClockedIn ? 'Clock Out' : 'Clock In';
        },
        get homeTasks() {
          if (!this.user) return [];
          const tasks = this.dailyTasks[this.todayFormatted]?.[this.user.name] || [];
          const completed = this.completedTasks[this.todayFormatted]?.[this.user.name] || {};
          return tasks.map(task => ({ name: task, status: completed[task] ? 'completed' : 'pending' }));
        },
        get myTasks() {
          if (!this.user) return [];
          const tasks = this.dailyTasks[this.todayFormatted]?.[this.user.name] || [];
          const completed = this.completedTasks[this.todayFormatted]?.[this.user.name] || {};
          return tasks.map(taskName => {
            const completionData = completed[taskName];
            const isCompleted = !!completionData;
            const timestamp = typeof completionData === 'object' ? completionData.timestamp : completionData;
            const imageName = typeof completionData === 'object' ? completionData.imageName : null;
            const status = isCompleted ? 'completed' : (this.isPastEndOfDay(this.todayFormatted) ? 'incomplete' : 'pending');
            return { name: taskName, status, timestamp, timestampDisplay: timestamp ? this.formatTimestampToTime(timestamp) : '', imageName };
          });
        },
        get weeklyRota() {
          const weekDays = this.getWeekDays(new Date());
          return weekDays.map(day => {
            const formattedDate = this.getFormattedDate(day);
            const dayRota = this.rota[formattedDate] || {};
            const shifts = this.staff.filter(member => {
              if (this.user && !this.isCurrentUserAdmin()) {
                if (this.user.role === 'FOH' && member.role === 'BOH') return false;
                if (this.user.role === 'BOH' && member.role === 'FOH') return false;
              }
              return true;
            }).sort((a, b) => {
              const order = { 'FOH': 1, 'BOH': 2, 'Admin': 3 };
              return order[a.role] - order[b.role] || a.name.localeCompare(b.name);
            }).map(member => ({ name: member.name, role: member.role, shift: dayRota[member.name] || 'Off' }));
            return { date: formattedDate, displayDate: this.getDisplayDate(day), shifts };
          });
        },
        get calendarDays() {
          const year = this.currentCalendarDate.getFullYear();
          const month = this.currentCalendarDate.getMonth();
          const firstDayOfMonth = new Date(year, month, 1);
          const lastDayOfMonth = new Date(year, month + 1, 0);
          const numDaysInMonth = lastDayOfMonth.getDate();
          const firstDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7;
          let days = [];
          for (let i = 0; i < firstDayOfWeek; i++) days.push({ date: null, dayNumber: '', currentMonth: false, isToday: false, shifts: [] });
          const todayFormatted = this.getFormattedDate(new Date());
          for (let dayNum = 1; dayNum <= numDaysInMonth; dayNum++) {
            const dayDate = new Date(year, month, dayNum);
            const formattedDate = this.getFormattedDate(dayDate);
            const isToday = formattedDate === todayFormatted;
            const dayRota = this.rota[formattedDate] || {};
            const shifts = this.staff.filter(member => {
              if (this.user && !this.isCurrentUserAdmin()) {
                if (this.user.role === 'FOH' && member.role === 'BOH') return false;
                if (this.user.role === 'BOH' && member.role === 'FOH') return false;
              }
              return this.calendarRoleFilter === 'all' || member.role === this.calendarRoleFilter;
            }).sort((a, b) => a.name.localeCompare(b.name))
              .map(member => ({ name: member.name, role: member.role, type: dayRota[member.name] || 'Off' }))
              .filter(s => s.type !== 'Off');
            days.push({ date: formattedDate, dayNumber: dayNum, currentMonth: true, isToday, shifts });
          }
          return days;
        },
        get workingStaff() {
          const today = this.getFormattedDate(new Date());
          const todayRota = this.rota[today] || {};
          const foh = [], boh = [], admin = [];
          this.staff.filter(member => {
            if (this.user && !this.isCurrentUserAdmin()) {
              if (this.user.role === 'FOH' && member.role === 'BOH') return false;
              if (this.user.role === 'BOH' && member.role === 'FOH') return false;
            }
            return true;
          }).forEach(member => {
            const shift = todayRota[member.name];
            if (shift && shift !== 'Off') {
              const data = { name: member.name, role: member.role, icon: member.icon, shift };
              (member.role === 'FOH' ? foh : member.role === 'BOH' ? boh : admin).push(data);
            }
          });
          return { foh, boh, admin };
        },

        // --- Utility Methods ---
        loadData(key) { try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : null; } catch { return null; } },
        saveData(key, data) { try { localStorage.setItem(key, JSON.stringify(data)); } catch (e) { alert("LocalStorage full."); } },
        getFormattedDate(date) { const y = date.getFullYear(); const m = (date.getMonth()+1).toString().padStart(2,'0'); const d = date.getDate().toString().padStart(2,'0'); return `${y}-${m}-${d}`; },
        formatTimestampToTime(ts) { return ts ? new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : 'N/A'; },
        getDisplayDate(date) { return date.toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'}); },
        addDays(d, n) { const dt = new Date(d); dt.setDate(dt.getDate()+n); return dt; },
        isPastEndOfDay(str) { const chk = new Date(str); chk.setHours(23,59,59,999); const now = new Date(); now.setHours(0,0,0,0); return chk < now; },
        isCurrentUserAdmin() { return this.user?.role === 'Admin'; },
        getWeekDays(start) { const ms = start.getTime(); const day = start.getDay(); const mon = new Date(ms - ((day+6)%7)*86400000); return Array.from({length:7}, (_,i)=>new Date(mon.getTime()+i*86400000)); },
        cleanupOldData() { const cutoff = Date.now() - 86400000; this.messageBoard = this.messageBoard.filter(m=>m.timestamp>cutoff); this.saveData('messageBoard',this.messageBoard); const ct = {}; for(const date in this.completedTasks){ if(this.isPastEndOfDay(date)){ const perDay = {}; for(const user in this.completedTasks[date]){ const keep = {}; for(const t in this.completedTasks[date][user]){ const ts = typeof this.completedTasks[date][user][t]==='object'?this.completedTasks[date][user][t].timestamp:this.completedTasks[date][user][t]; if(ts>cutoff) keep[t]=this.completedTasks[date][user][t]; } if(Object.keys(keep).length) perDay[user]=keep; } if(Object.keys(perDay).length) ct[date]=perDay; } else ct[date]=this.completedTasks[date]; } this.completedTasks=ct; this.saveData('completedTasks',this.completedTasks); },

        // --- Initialization ---
        initializeAlpineApp() {
          this.staff = this.loadData('staffMembers') || [
            {name:'Jill',role:'FOH',icon:'💁‍♀️'},
            {name:'Alice',role:'FOH',icon:'💁‍♀️'},
            {name:'Callum',role:'FOH',icon:'💁‍♀️'},
            {name:'Jess',role:'FOH',icon:'💁‍♀️'},
            {name:'Danny',role:'BOH',icon:'👩‍🍳'},
            {name:'Neil',role:'BOH',icon:'👩‍🍳'},
            {name:'Terry',role:'BOH',icon:'👴'},
            {name:'Richard',role:'BOH',icon:'👩‍🍳'},
            {name:'Johnny',role:'Admin',icon:'🤵'},
            {name:'Lyndsey',role:'Admin',icon:'🤵'},
            {name:'Collin',role:'Admin',icon:'🤵'}
          ];
          this.rota = this.loadData('rota')||{};
          this.dailyTasks = this.loadData('dailyTasks')||{};
          this.completedTasks = this.loadData('completedTasks')||{};
          this.clockIns = this.loadData('clockIns')||{};
          this.messageBoard = this.loadData('messageBoard')||[];

          const uName = this.loadData('currentUserName');
          const uRole = this.loadData('currentUserRole');
          if(uName&&uRole){ this.user = this.staff.find(s=>s.name===uName&&s.role===uRole)||null; if(this.user.role==='Admin') this.isAdminMode = this.loadData('isAdminMode')||false; }

          if(this.user){ this.view='home'; this.cleanupOldData(); } else { this.user=null; this.view='landing'; }

          const today = this.getFormattedDate(new Date());
          ['shiftForm.date','taskForm.date','assignedShiftsView.date','assignedTasksView.date','attendanceView.date','taskOverviewView.date']
            .forEach(k=>{ const parts=k.split('.'); this[parts[0]][parts[1]] = today; });

          this.shiftForm.staffName = this.user?.name||this.staff[0].name;
          this.taskForm.staffName  = this.user?.name||this.staff[0].name;
          this.assignedShiftsView.staffName  = this.user?.name||this.staff[0].name;
          this.assignedTasksView.staffName  = this.user?.name||this.staff[0].name;

          document.querySelector('footer span').textContent = new Date().getFullYear();
        },

        // --- Auth ---
        login(member) { this.user=member; this.saveData('currentUserName',member.name); this.saveData('currentUserRole',member.role); this.isAdminMode=false; this.saveData('isAdminMode',false); this.view='home'; this.cleanupOldData(); },
        logout() { this.user=null; this.isAdminMode=false; this.saveData('currentUserName',null); this.saveData('currentUserRole',null); this.saveData('isAdminMode',false); },
        toggleAdminMode() { if(!this.isCurrentUserAdmin()){ alert('No permission'); return; } this.isAdminMode=!this.isAdminMode; this.saveData('isAdminMode',this.isAdminMode); this.view = this.isAdminMode?'admin':'home'; },

        // Other methods (render, assign, delete, toggleClockStatus, sendMessage, toggleTaskCompletion, attachImageToTask, etc.) go here unchanged...

      }
    }

    document.addEventListener('alpine:init', () => {
      Alpine.data('app', app)
    })
  </script>

  <style>
    /* Your entire CSS block unchanged */
    [x-cloak] { display: none !important; }
    /* ... rest of your styles ... */
  </style>
</head>

<body class="bg-gray-100 text-gray-800 font-sans">
  <!-- Landing Screen -->
  <div x-show="!user" x-transition class="min-h-screen flex flex-col items-center justify-center px-4" id="landing-page">
    <!-- ... landing markup ... -->
  </div>

  <!-- App Container -->
  <div x-show="user" x-transition class="min-h-screen flex flex-col" id="app-container">
    <!-- Header, Nav, Main, Footer markup unchanged -->
  </div>
</body>
</html>
