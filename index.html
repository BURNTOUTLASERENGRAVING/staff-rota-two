<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Staff Rota & Task Checklist</title>
  <style>
    /* CSS Styles omitted for brevity... */
    /* (Include all your CSS here unchanged) */
  </style>
</head>
<body>
    <!-- Landing Page -->
    <div id="landing-page">
        <h1>Welcome, Staff!</h1>
        <p>Please select your profile to continue:</p>
        <div id="staff-icons-container"></div>
    </div>

    <!-- Main App Container -->
    <div id="app-container">
        <header>
            <h1>Staff Rota & Tasks</h1>
            <div class="top-controls">
                <span id="user-info"></span>
                <button id="admin-toggle-btn">Admin Mode</button>
                <button id="sign-out-btn">Sign Out</button>
            </div>
            <nav class="nav-buttons">
                <button id="nav-home" class="active">Home</button>
                <button id="nav-my-tasks">My Tasks</button>
                <button id="nav-weekly-rota">Weekly Rota</button>
                <button id="nav-calendar">Calendar View</button>
            </nav>
        </header>
        <main>
            <!-- Sections omitted for brevity... -->
        </main>
        <footer>&copy; <span id="current-year"></span> Staff Rota & Task Checklist</footer>
    </div>

    <script>
        // All your existing JS logic up to before missing functions

        /**
         * Navigates to the chosen view on nav button click.
         */
        function handleNavButtonClick(event) {
            const view = event.target.id.replace('nav-', '') + '-view';
            showView(view);
        }

        /**
         * Toggles Admin Mode on/off.
         */
        function toggleAdminView() {
            isAdminMode = !isAdminMode;
            saveData(LS_KEYS.IS_ADMIN_MODE, isAdminMode);
            renderAdminToggleButton();
            showView(isAdminMode ? 'admin-view' : 'home-view');
        }

        /**
         * Fix delete logic: ensure using taskDate not undefined 'date'.
         */
        function handleTaskCompletionOrImageAttach(event) {
            if (event.target.type === 'checkbox') {
                const { taskName: taskName, taskDate, staffName } = event.target.dataset;
                if (!completedTasks[taskDate]) completedTasks[taskDate] = {};
                if (!completedTasks[taskDate][staffName]) completedTasks[taskDate][staffName] = {};
                if (event.target.checked) {
                    completedTasks[taskDate][staffName][taskName] = { timestamp: Date.now(), imageName: completedTasks[taskDate][staffName][taskName]?.imageName };
                } else {
                    delete completedTasks[taskDate][staffName][taskName];
                    if (Object.keys(completedTasks[taskDate][staffName]).length === 0) {
                        delete completedTasks[taskDate][staffName];
                    }
                    if (Object.keys(completedTasks[taskDate]).length === 0) {
                        delete completedTasks[taskDate];
                    }
                }
                saveData(LS_KEYS.COMPLETED_TASKS, completedTasks);
                renderHomePage(); renderMyTasks(); if (isAdminMode) renderAdminTaskOverview();
            } else if (event.target.type === 'file') {
                const fileInput = event.target;
                const { taskName: taskName, taskDate, staffName } = fileInput.dataset;
                const file = fileInput.files[0];
                if (file) {
                    if (!completedTasks[taskDate]) completedTasks[taskDate] = {};
                    if (!completedTasks[taskDate][staffName]) completedTasks[taskDate][staffName] = {};
                    const timestamp = completedTasks[taskDate][staffName][taskName]?.timestamp || Date.now();
                    completedTasks[taskDate][staffName][taskName] = { timestamp, imageName: file.name };
                    saveData(LS_KEYS.COMPLETED_TASKS, completedTasks);
                    alert(`Image "${file.name}" attached to "${taskName}".`);
                    renderHomePage(); renderMyTasks(); if (isAdminMode) renderAdminTaskOverview();
                }
            }
        }

        // Rest of your initApp, render and utility functions unchanged

        document.addEventListener('DOMContentLoaded', () => {
            initializeData();
            renderLandingPage();
            if (currentUserName) {
                landingPage.style.display = 'none';
                appContainer.style.display = 'flex';
                initApp();
            }
        });
    </script>
</body>
</html>
