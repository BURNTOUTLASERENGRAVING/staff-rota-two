<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Staff Rota & Task Checklist</title>
  <!-- PWA Manifest Link (Commented out for now) -->
  <!-- <link rel="manifest" href="manifest.json"> -->
  <style>
    /*
     * CSS Styles
     */

    :root {
      --primary-bg: #f4f4f4;
      --secondary-bg: #ffffff;
      --text-color: #333;
      --light-grey: #e0e0e0;
      --dark-grey: #444;
      --header-bg: #222;
      --accent-color: #6a0dad;
      --accent-hover: #8a2be2;
      --border-color: #ddd;
      --incomplete-bg: #ffe0b2;
      --incomplete-border: #ff8c00;
      --completed-bg: #e6ffe6;
      --completed-border: #4CAF50;
      --delete-btn-bg: #dc3545;
      --delete-btn-hover: #c82333;
      --holiday-bg: #ffeeee;
      --holiday-border: #ff6b6b;
      --personal-holiday-bg: #e6f7ff;
      --personal-holiday-border: #007bff;
      --foh-color: #007bff;
      --boh-color: #28a745;
      --admin-color: #6c757d;
      --foh-light-bg: #e0f2f7;
      --boh-light-bg: #e6ffe6;
      --admin-light-bg: #f0f0f0;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Segoe UI', sans-serif;
      line-height: 1.6;
      background: var(--primary-bg);
      color: var(--text-color);
      display: flex; flex-direction: column;
      min-height: 100vh; padding: 10px;
      align-items: center;
      justify-content: center;
    }

    #landing-page {
      background: var(--secondary-bg); border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      margin: auto; padding: 40px; text-align: center; max-width: 600px; width: 100%;
      display: flex; flex-direction: column; animation: fadeIn 0.5s ease-out;
    }
    #landing-page h1 { color: var(--accent-color); font-size: 2em; margin-bottom: 25px; }
    #landing-page p  { color: var(--dark-grey); margin-bottom: 25px; font-size: 1.1em; }
    #staff-icons-container {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 20px; margin-bottom: 30px; width: 100%; min-height: 120px;
      align-items: start; justify-items: center;
    }
    .staff-icon {
      background: var(--light-grey); border-radius: 12px; padding: 15px 5px; cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column;
      align-items: center; justify-content: center; min-height: 120px; min-width: 100px;
      animation: pulse 2s infinite ease-in-out; transition: all 0.2s ease;
    }
    .staff-icon:hover {
      background: var(--accent-hover); transform: translateY(-5px) scale(1.03); color: #fff;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    .staff-icon.selected {
      background-color: var(--accent-color); color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transform: translateY(-2px) scale(1.02); border: 2px solid white; animation: none;
    }
    .icon-placeholder { font-size: 3em; margin-bottom: 8px; line-height: 1; }
    .staff-icon.foh .icon-placeholder { color: var(--foh-color); }
    .staff-icon.boh .icon-placeholder { color: var(--boh-color); }
    .staff-icon.admin .icon-placeholder { color: var(--admin-color); }
    .staff-icon.selected .icon-placeholder { color: white; }
    .staff-name {
      font-weight: bold; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      text-align: center; max-width: 90%;
    }
    .staff-role {
      font-size: 0.85em; padding: 3px 8px; border-radius: 4px; background: rgba(0,0,0,0.1);
      color: var(--dark-grey);
    }
    .staff-icon.selected .staff-role { background-color: rgba(255,255,255,0.2); color: white; }
    #login-button { display: none; }

    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    #app-container {
      display: none; flex-direction: column; background: var(--secondary-bg); border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15); margin: 20px auto; max-width: 960px;
      width: 100%; min-height: 90vh; overflow: hidden;
    }
    header {
      background: var(--header-bg); color: #fff; padding: 15px 25px; display: flex;
      flex-direction: column; align-items: flex-start; gap: 15px; position: sticky;
      top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    header h1 { font-size: 1.8em; color: var(--accent-hover); letter-spacing: 0.5px; margin-bottom: 0; }
    header .top-controls { display: flex; flex-wrap: wrap; gap: 15px; width: 100%; align-items: center; justify-content: flex-start; }
    header .nav-buttons { display: flex; flex-wrap: wrap; gap: 8px; width: 100%; }
    header label { color: var(--light-grey); font-weight: bold; white-space: nowrap; display: flex; align-items: center; }
    header #user-info { font-weight: bold; color: var(--light-grey); font-size: 1.1em; white-space: nowrap; margin-right: 10px; }
    header button {
      padding: 10px 15px; border: none; border-radius: 6px; font-size: 0.95em; cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease; white-space: nowrap;
    }
    header #sign-out-btn { background-color: #6c757d; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
    header #sign-out-btn:hover { background-color: #5a6268; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    header button:not(#sign-out-btn) { background-color: var(--accent-color); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
    header button:not(#sign-out-btn):hover { background-color: var(--accent-hover); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    header button:active { transform: translateY(0); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    header .nav-buttons button.active { background-color: var(--accent-hover); box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); transform: translateY(0); }
    header .nav-buttons button:disabled { background-color: #555; cursor: not-allowed; transform: none; box-shadow: none; }

    main {
      padding: 25px; flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto;
      -ms-overflow-style: none; scrollbar-width: none;
    }
    main::-webkit-scrollbar { display: none; }
    section {
      background-color: var(--secondary-bg); border-radius: 8px; padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; border: 1px solid var(--border-color);
      display: none; flex-direction: column; flex-grow: 1; transition: opacity 0.3s ease-in-out;
    }
    section.active { display: flex; opacity: 1; }
    h2 { color: var(--accent-color); margin-bottom: 20px; font-size: 1.6em; padding-bottom: 8px; border-bottom: 2px solid var(--light-grey); text-align: center; }
    h3 { color: var(--dark-grey); margin-top: 25px; margin-bottom: 12px; font-size: 1.2em; }
    h4 { color: var(--dark-grey); margin-top: 15px; margin-bottom: 8px; font-size: 1em; font-weight: bold; }

    .info-banner { background-color: rgba(106,13,173,0.1); color: var(--accent-color); padding: 12px 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.95em; text-align: center; border: 1px solid rgba(106,13,173,0.2); }
    .status-banner { background-color: var(--light-grey); padding: 12px 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.95em; text-align: center; border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; gap: 15px; }
    .status-banner.clocked-in { background-color: var(--completed-bg); border-color: var(--completed-border); color: var(--boh-color); }
    .status-banner.clocked-out { background-color: var(--incomplete-bg); border-color: var(--incomplete-border); color: var(--incomplete-border); }
    .status-banner button { flex-shrink: 0; padding: 8px 15px; font-size: 0.9em; border-radius: 6px; transition: background-color 0.2s ease; }
    .status-banner.clocked-in button { background-color: var(--incomplete-border); color: white; }
    .status-banner.clocked-in button:hover { background-color: #e07b00; }
    .status-banner.clocked-out button { background-color: var(--boh-color); color: white; }
    .status-banner.clocked-out button:hover { background-color: #218838; }

    .rota-grid-container { overflow-x: auto; padding-bottom: 10px; }
    #weekly-rota-view .rota-grid { display: grid; grid-template-columns: repeat(7, minmax(140px, 1fr)); gap: 12px; min-width: 1000px; text-align: center; }
    #whos-working-holiday-message { background-color: var(--holiday-bg); color: var(--holiday-border); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 1.1em; text-align: center; border: 1px solid var(--holiday-border); font-weight: bold; }
    #home-view .who-is-working-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .rota-day-column, .working-staff-column { background-color: var(--light-grey); border-radius: 8px; padding: 15px 10px; border: 1px solid var(--border-color); box-shadow: 0 2px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
    .working-staff-column { padding: 10px 5px; }
    .working-staff-column strong { display: block; margin-bottom: 5px; color: var(--accent-color); font-size: 1em; }
    .rota-day-column strong { display: block; margin-bottom: 10px; color: var(--accent-color); font-size: 1em; }
    .rota-day-column ul, .working-staff-column ul { list-style: none; padding: 0; width: 100%; }
    .rota-day-column li { background-color: var(--secondary-bg); padding: 8px 5px; margin-bottom: 5px; border-radius: 5px; font-size: 0.9em; border: 1px solid var(--light-grey); text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .rota-day-column li:last-child { margin-bottom: 0; }
    .rota-day-column li.foh, .working-staff-column li.foh { color: var(--foh-color); }
    .rota-day-column li.boh, .working-staff-column li.boh { color: var(--boh-color); }
    .rota-day-column li.admin, .working-staff-column li.admin { color: var(--admin-color); }
    .working-staff-column .staff-icon { background: var(--secondary-bg); border-radius: 8px; padding: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); margin-bottom: 8px; flex-shrink: 0; width: 100%; min-height: unset; min-width: unset; animation: none; cursor: default; }
    .working-staff-column .staff-icon:hover { transform: none; box-shadow: 0 1px 4px rgba(0,0,0,0.05); background: var(--secondary-bg); color: var(--text-color); }
    .working-staff-column .staff-icon .icon-placeholder { font-size: 2.5em; margin-bottom: 5px; }
    .working-staff-column .staff-icon .staff-name { font-size: 1em; margin-bottom: 2px; }
    .working-staff-column .staff-icon .staff-role { font-size: 0.8em; padding: 2px 6px; background-color: rgba(0,0,0,0.05); color: var(--dark-grey); word-break: break-word; }
    .working-staff-column .staff-icon.on-holiday .staff-role { background-color: var(--personal-holiday-bg); color: var(--personal-holiday-border); font-weight: bold; }

    #my-tasks-view .info-banner { font-weight: bold; }
    #task-list { list-style: none; padding: 0; flex-grow: 1; }
    .task-item { background-color: var(--secondary-bg); border: 1px solid var(--border-color); border-left: 5px solid var(--accent-color); padding: 12px 18px; margin-bottom: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; gap: 15px; transition: background-color 0.3s ease, border-color 0.3s ease, transform 0.2s ease; box-shadow: 0 1px 4px rgba(0,0,0,0.05); flex-wrap: wrap; }
    .task-item:hover { transform: translateY(-2px); box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
    .task-item-controls { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
    .task-item input[type="checkbox"] { margin-right: 0px; min-width: 24px; min-height: 24px; accent-color: var(--accent-color); cursor: pointer; transform: scale(1.1); }
    .task-item .upload-image-btn { background-color: var(--dark-grey); color: white; padding: 6px 10px; border: none; border-radius: 5px; font-size: 0.8em; cursor: pointer; transition: background-color 0.2s ease; }
    .task-item .upload-image-btn:hover { background-color: #555; }
    .task-item .attached-image-info { font-size: 0.75em; color: var(--dark-grey); margin-left: 10px; flex-basis: 100%; text-align: right; margin-top: 5px; }
    .task-item.completed { background-color: var(--completed-bg); border-color: var(--completed-border); border-left-color: var(--completed-border); text-decoration: line-through; color: var(--dark-grey); opacity: 0.8; box-shadow: none; }
    .task-item.incomplete { background-color: var(--incomplete-bg); border-color: var(--incomplete-border); border-left-color: var(--incomplete-border); animation: pulse-incomplete 1.5s infinite alternate; }
    @keyframes pulse-incomplete { from { box-shadow: 0 0 0 0 rgba(255,140,0,0.3); } to { box-shadow: 0 0 0 8px rgba(255,140,0,0); } }
    .task-item span { flex-grow: 1; font-size: 1.05em; }
    .task-item .timestamp { font-size: 0.85em; color: var(--dark-grey); white-space: nowrap; text-align: right; }
    .no-tasks, .no-data { text-align: center; padding: 20px; color: var(--dark-grey); font-style: italic; background-color: var(--light-grey); border-radius: 8px; margin-top: 15px; }

    #home-view #my-tasks-for-home, #home-view #message-board { margin-top: 20px; }
    #message-board .message-list { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--primary-bg); }
    .message-list li { padding: 8px 15px; border-bottom: 1px solid var(--light-grey); font-size: 0.9em; }
    .message-list li:last-child { border-bottom: none; }
    .message-list .message-sender { font-weight: bold; color: var(--accent-color); margin-right: 5px; }
    .message-list .message-timestamp { font-size: 0.8em; color: var(--dark-grey); }
    #message-input-form { display: flex; gap: 10px; margin-top: 15px; align-items: center; }
    #message-input-form textarea { flex-grow: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; min-height: 60px; resize: vertical; font-family: inherit; font-size: 0.9em; background-color: var(--primary-bg); }
    #message-input-form button { padding: 10px 15px; font-size: 0.9em; border-radius: 6px; background-color: var(--accent-color); color: white; border: none; cursor: pointer; }
    #message-input-form button:hover { background-color: var(--accent-hover); }

    /* Shared Calendar Controls */
    .calendar-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
    }
    .calendar-controls h3, .calendar-controls h4 { /* h4 for admin availability calendar title */
        margin: 0;
        font-size: 1.4em;
        color: var(--accent-color);
    }
    .calendar-controls h4 { font-size: 1.2em; } /* Slightly smaller for h4 */
    .calendar-controls button {
        background-color: var(--dark-grey);
        color: white;
        padding: 8px 12px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .calendar-controls button:hover { background-color: #555; }
    .calendar-controls select {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        font-size: 0.9em;
        background-color: var(--primary-bg);
        color: var(--text-color);
    }
    .calendar-controls select:disabled { background-color: #f0f0f0; cursor: not-allowed; }

    /* Shared Calendar Grid styles */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 15px;
    }
    .calendar-grid .day-name {
      font-weight: bold;
      text-align: center;
      padding: 10px 5px;
      background-color: var(--light-grey);
      border-radius: 5px;
      color: var(--dark-grey);
      font-size: 0.9em;
    }

    /* Main Calendar View & Admin Availability Calendar Day Styling */
    .calendar-day { background-color: var(--primary-bg); border: 1px solid var(--border-color); border-radius: 5px; min-height: 100px; padding: 8px; display: flex; flex-direction: column; overflow: hidden; font-size: 0.85em; position: relative; }
    .calendar-day.current-month { background-color: var(--secondary-bg); }
    .calendar-day.today { border: 2px solid var(--accent-color); box-shadow: 0 0 0 2px rgba(106,13,173,0.3); }
    .calendar-day.holiday-day { background-color: var(--holiday-bg); border: 1px solid var(--holiday-border); }
    .calendar-day.holiday-day .day-number { color: var(--holiday-border); }
    .calendar-day.personal-holiday-day { background-color: var(--personal-holiday-bg); border: 1px solid var(--personal-holiday-border); }
    .calendar-day.personal-holiday-day .day-number { color: var(--personal-holiday-border); }
    .calendar-day.holiday-day.personal-holiday-day { background-color: var(--holiday-bg); border-color: var(--holiday-border); }
    .calendar-day.holiday-day.personal-holiday-day .day-number { color: var(--holiday-border); }
    .calendar-day.holiday-day:hover::after, .calendar-day.personal-holiday-day:hover::after { content: attr(title); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--dark-grey); color: white; padding: 3px 6px; border-radius: 4px; font-size: 0.9em; white-space: pre-wrap; z-index: 10; margin-bottom: 5px; text-align: left; }
    .calendar-day .day-number { font-weight: bold; font-size: 1.1em; color: var(--accent-color); margin-bottom: 5px; text-align: right; padding-right: 5px; }
    .calendar-day ul { list-style: none; padding: 0; margin-top: 5px; flex-grow: 1; overflow-y: auto; -ms-overflow-style: none; scrollbar-width: none; }
    .calendar-day ul::-webkit-scrollbar { display: none; }
    .calendar-day li { padding: 3px 6px; margin-bottom: 3px; border-radius: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.8em; color: var(--dark-grey); }
    #calendar-view .calendar-day li.foh-shift { background-color: var(--foh-light-bg); color: var(--foh-color); }
    #calendar-view .calendar-day li.boh-shift { background-color: var(--boh-light-bg); color: var(--boh-color); }
    #calendar-view .calendar-day li.admin-shift { background-color: var(--admin-light-bg); color: var(--admin-color); }


    /* My Availability View */
    #availability-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); } /* Already uses .calendar-grid */
    .availability-day-column { background-color: var(--light-grey); border-radius: 8px; padding: 15px; border: 1px solid var(--border-color); box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .availability-day-column strong { display: block; margin-bottom: 10px; color: var(--accent-color); font-size: 1.1em; text-align: center; }
    .availability-day-column .availability-slots label { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.95em; cursor: pointer; padding: 5px; border-radius: 4px; transition: background-color 0.2s ease; }
    .availability-day-column .availability-slots label:hover { background-color: #e9e9e9; }
    .availability-day-column .availability-slots input[type="checkbox"] { margin-right: 10px; min-width: 18px; min-height: 18px; accent-color: var(--accent-color); }
    .availability-day-column .availability-slots input[type="checkbox"]:checked + span { font-weight: bold; color: var(--accent-color); }
    #staff-availability-display-admin { border-left: 3px solid var(--accent-color); }
    #staff-availability-display-admin strong { color: var(--accent-color); }

    /* Admin Availability Calendar Specifics */
     #admin-availability-calendar-section #admin-availability-calendar-grid.calendar-grid { /* More specific selector */
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-top: 15px;
    }
    #admin-availability-calendar-grid .calendar-day ul { font-size: 0.78em; max-height: 70px; padding-left: 3px; line-height: 1.3; }
    #admin-availability-calendar-grid .calendar-day li { padding: 2px 4px; margin-bottom: 2px; border-radius: 3px; white-space: normal; word-break: break-word; }
    #admin-availability-calendar-grid .calendar-day li.avail-morning { background-color: #fff3cd; color: #856404; border-left: 3px solid #ffda6b; }
    #admin-availability-calendar-grid .calendar-day li.avail-afternoon { background-color: #d1ecf1; color: #0c5460; border-left: 3px solid #75c6d6; }
    #admin-availability-calendar-grid .calendar-day li.avail-evening { background-color: #d4edda; color: #155724; border-left: 3px solid #65c476; }
    #admin-availability-calendar-grid .calendar-day li.avail-fullday { background-color: #cce5ff; color: #004085; border-left: 3px solid #6baaff; font-weight: bold; }
    #admin-availability-calendar-grid .calendar-day li.avail-unavailable { background-color: #f8d7da; color: #721c24; border-left: 3px solid #f0828a; }
    #admin-availability-calendar-grid .calendar-day li.no-availability-specified,
    #admin-availability-calendar-grid .calendar-day li.no-data { /* Shared style for no data messages */
        font-style: italic; color: var(--dark-grey); background-color: transparent; border-left: none; text-align: center; padding: 5px 0;
    }


    #admin-view { background-color: var(--light-grey); padding: 25px; border-radius: 12px; margin-top: 20px; box-shadow: inset 0 2px 6px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
    .admin-section { background-color: var(--secondary-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 25px; box-shadow: 0 1px 5px rgba(0,0,0,0.05); }
    .admin-section form { display: grid; grid-template-columns: 1fr; gap: 15px; }
    .admin-section label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.95em; color: var(--dark-grey); }
    .admin-section input[type="text"], .admin-section input[type="date"], .admin-section input[type="number"], .admin-section select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.95em; background-color: var(--primary-bg); transition: border-color 0.2s ease, box-shadow 0.2s ease; }
    .admin-section input[type="text"]:focus, .admin-section input[type="date"]:focus, .admin-section input[type="number"]:focus, .admin-section select:focus { outline: none; border-color: var(--accent-hover); box-shadow: 0 0 0 3px rgba(106,13,173,0.2); }
    .admin-section input:disabled, .admin-section select:disabled, .admin-section button:disabled { background-color: #f0f0f0; cursor: not-allowed; box-shadow: none; border-color: #ccc; opacity: 0.7; }
    .admin-section .delete-btn[disabled] { background-color: #cccccc; cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
    .admin-section button { background-color: var(--accent-color); color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.05em; transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease; width: fit-content; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
    .admin-section button:hover { background-color: var(--accent-hover); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .admin-section button:active { transform: translateY(0); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    #admin-assigned-tasks, #admin-assigned-shifts, #admin-attendance-list, #admin-task-overview-list, #admin-view-tasks-list, #admin-holiday-list { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--primary-bg); box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
    #admin-assigned-tasks li, #admin-assigned-shifts li, #admin-attendance-list li, #admin-task-overview-list li, #admin-view-tasks-list li, #admin-holiday-list li { padding: 10px 15px; border-bottom: 1px solid var(--light-grey); display: flex; justify-content: space-between; align-items: center; font-size: 0.95em; transition: background-color 0.2s ease; }
    #admin-holiday-list li span { white-space: normal; word-break: break-word; }
    #admin-assigned-tasks li:last-child, #admin-assigned-shifts li:last-child, #admin-attendance-list li:last-child, #admin-task-overview-list li:last-child, #admin-view-tasks-list li:last-child, #admin-holiday-list li:last-child { border-bottom: none; }
    #admin-assigned-tasks li:hover, #admin-assigned-shifts li:hover, #admin-attendance-list li:hover, #admin-task-overview-list li:hover, #admin-view-tasks-list li:hover, #admin-holiday-list li:hover { background-color: #f0f0f0; }
    #admin-assigned-tasks li span, #admin-assigned-shifts li span, #admin-attendance-list li span, #admin-task-overview-list li span, #admin-view-tasks-list li span, #admin-holiday-list li span { flex-grow: 1; }

    .delete-btn { background-color: var(--delete-btn-bg); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.85em; transition: background-color 0.2s ease, transform 0.1s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-left: 10px; flex-shrink: 0; }
    .delete-btn:hover { background-color: var(--delete-btn-hover); transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
    .delete-btn:active { transform: translateY(0); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .admin-task-overview-item.completed { background-color: var(--completed-bg); color: var(--boh-color); border-left: 4px solid var(--completed-border); }
    .admin-task-overview-item.pending { background-color: var(--secondary-bg); color: var(--dark-grey); border-left: 4px solid var(--dark-grey); }
    .admin-task-overview-item.overdue { background-color: var(--incomplete-bg); color: var(--incomplete-border); border-left: 4px solid var(--incomplete-border); }

    footer { text-align: center; padding: 15px; font-size: 0.8em; color: var(--dark-grey); border-top: 1px solid var(--border-color); background-color: var(--light-grey); margin-top: auto; border-radius: 0 0 12px 12px; }
    #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast { background-color: #333; color: white; padding: 10px 20px; border-radius: 6px; opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease-out, transform 0.3s ease-out; box-shadow: 0 4px 12px rgba(0,0,0,0.2); min-width: 200px; text-align: center; font-size: 0.9em; pointer-events: auto; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background-color: #28a745; } .toast.error { background-color: #dc3545; } .toast.info { background-color: #007bff; } .toast.warning { background-color: #ffc107; color: #333;}

    @media (min-width: 768px) {
      header { flex-direction: row; justify-content: space-between; align-items: center; flex-wrap: wrap; }
      header .top-controls { width: auto; justify-content: flex-end; order: 2; }
      header h1 { margin-bottom: 0; order: 1; }
      header .nav-buttons { width: auto; order: 3; margin-top: 10px; flex-grow: 1; justify-content: center; }
      #weekly-rota-view .rota-grid { grid-template-columns: repeat(7, 1fr); min-width: unset; }
      .admin-section form { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); align-items: end; }
      .admin-section form button { grid-column: span 1; width: auto; }
      #add-holiday-form { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
      #add-holiday-form button { grid-column: span 1; }
    }
    @media (min-width: 1024px) {
      header .nav-buttons { margin-top: 0; order: 2; }
      header .top-controls { order: 3; }
      header h1 { order: 1; }
    }
  </style>
</head>
<body>
    <div id="landing-page">
        <h1>Welcome, Staff!</h1>
        <p>Please select your profile to continue:</p>
        <div id="staff-icons-container"></div>
    </div>

    <div id="app-container">
        <header>
            <h1>Staff Rota & Tasks</h1>
            <div class="top-controls">
                <span id="user-info"></span>
                <button id="admin-toggle-btn">Admin Mode</button>
                <button id="sign-out-btn">Sign Out</button>
            </div>
            <nav class="nav-buttons">
                <button id="nav-home" class="active">Home</button>
                <button id="nav-my-tasks">My Tasks</button>
                <button id="nav-my-availability">My Availability</button>
                <button id="nav-weekly-rota">Weekly Rota</button>
                <button id="nav-calendar">Calendar View</button>
            </nav>
        </header>

        <main>
            <section id="home-view" class="active">
                <div id="clock-status-banner-home" class="status-banner">
                    <span id="clock-status-text-home">Loading...</span>
                    <button id="clock-in-out-btn-home">Toggle</button>
                </div>
                <h2>Who's Working Today?</h2>
                <div id="whos-working-holiday-message" style="display: none;"></div>
                <div class="who-is-working-grid">
                    <div class="working-staff-column"><strong>FOH</strong><ul id="foh-working-list"><li class="no-data">...</li></ul></div>
                    <div class="working-staff-column"><strong>BOH</strong><ul id="boh-working-list"><li class="no-data">...</li></ul></div>
                    <div class="working-staff-column"><strong>Admin</strong><ul id="admin-working-list"><li class="no-data">...</li></ul></div>
                </div>
                <h2 id="my-tasks-for-home">Your Tasks for Today</h2>
                <ul id="home-task-list"><li class="no-tasks">...</li></ul>
                <h2 id="message-board">Message Board</h2>
                <div class="message-list-container">
                    <ul id="message-list"><li class="no-data">...</li></ul>
                    <form id="message-input-form"><textarea id="message-text" placeholder="Write..." rows="3" required></textarea><button type="submit">Send</button></form>
                </div>
            </section>

            <section id="my-tasks-view">
                <div class="info-banner">Your tasks for <span id="current-day-info">Today</span></div>
                <ul id="task-list"><li class="no-tasks">...</li></ul>
            </section>

            <section id="my-availability-view" style="display: none;">
                <h2>Set Your Weekly Availability</h2>
                <div class="availability-controls">
                    <button id="prev-week-availability-btn">← Previous Week</button>
                    <h3 id="current-availability-week"></h3>
                    <button id="next-week-availability-btn">Next Week →</button>
                </div>
                <div id="availability-grid-container">
                    <div id="availability-grid"></div>
                </div>
                 <p class="info-banner" style="margin-top: 20px; font-size: 0.9em;">
                    Note: This is to indicate your general availability. Management will use this as a guide when creating rotas. Submitting availability does not guarantee shifts.
                </p>
            </section>

            <section id="weekly-rota-view">
                <h2>Weekly Rota</h2>
                <div class="rota-grid-container"><div class="rota-grid"></div></div>
            </section>

            <section id="calendar-view">
                <h2>Monthly Rota Calendar</h2>
                <div class="calendar-controls">
                    <button id="prev-month-btn">← Prev</button><h3 id="current-month-year"></h3><button id="next-month-btn">Next →</button>
                    <select id="calendar-role-filter"><option value="all">All</option><option value="FOH">FOH</option><option value="BOH">BOH</option><option value="Admin">Admin</option></select>
                </div>
                <div class="calendar-grid"> <!-- This one is for the main calendar view -->
                    <div class="day-name">Mon</div><div class="day-name">Tue</div><div class="day-name">Wed</div><div class="day-name">Thu</div><div class="day-name">Fri</div><div class="day-name">Sat</div><div class="day-name">Sun</div>
                </div>
            </section>

            <section id="admin-view" style="display: none;">
                <h2>Admin Panel</h2>
                <div class="admin-section">
                    <h3>Assign Shifts</h3>
                    <form id="assign-shift-form">
                        <div><label for="shift-user-select">Staff:</label><select id="shift-user-select" required></select></div>
                        <div><label for="shift-date">Date:</label><input type="date" id="shift-date" required></div>
                        <div><label for="shift-type-select">Shift Type:</label><select id="shift-type-select" required><option value="">Select</option><option value="8AM-4PM">8AM-4PM</option><option value="12PM-8PM">12PM-8PM</option><option value="5PM-Close">5PM-Close</option><option value="Off">Off</option><option value="custom">Custom</option></select></div>
                        <div id="custom-shift-input-container" style="display:none;"><label for="custom-shift-type">Custom:</label><input type="text" id="custom-shift-type"></div>
                        <div><label for="shift-repeat-days">Repeat (days):</label><input type="number" id="shift-repeat-days" value="1" min="1" max="7"></div>
                        <div id="staff-availability-display-admin" class="info-banner" style="display: none; margin-top: 10px; padding: 8px; text-align: left; font-size: 0.9em;"></div>
                        <button type="submit">Assign Shift</button>
                    </form>
                </div>
                <div class="admin-section">
                    <h3>Assigned Shifts</h3>
                    <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;"><div><label for="view-shift-user-select">Staff:</label><select id="view-shift-user-select"></select></div><div><label for="view-shift-date">Date:</label><input type="date" id="view-shift-date"></div></div>
                    <ul id="admin-assigned-shifts"><li class="no-data">...</li></ul>
                </div>

                <div class="admin-section" id="admin-availability-calendar-section">
                    <h3>Staff Availability Calendar</h3>
                    <div class="calendar-controls">
                        <button id="admin-prev-month-availability-btn">← Prev Month</button>
                        <h4 id="admin-current-month-year-availability"></h4>
                        <button id="admin-next-month-availability-btn">Next Month →</button>
                        <select id="admin-availability-staff-filter">
                            <option value="all">All FOH/BOH</option>
                            <option value="FOH">All FOH Staff</option>
                            <option value="BOH">All BOH Staff</option>
                        </select>
                        <select id="admin-availability-slot-filter">
                            <option value="all_slots">All Slots</option>
                        </select>
                        <button id="refresh-admin-availability-btn" style="margin-left: auto;">Refresh Data</button>
                    </div>
                    <div class="calendar-grid" id="admin-availability-calendar-grid">
                        <div class="day-name">Mon</div> <div class="day-name">Tue</div> <div class="day-name">Wed</div> <div class="day-name">Thu</div> <div class="day-name">Fri</div> <div class="day-name">Sat</div> <div class="day-name">Sun</div>
                    </div>
                </div>

                <div class="admin-section">
                    <h3>Assign Daily Tasks</h3>
                    <form id="assign-task-form">
                        <div><label for="task-user-select">Staff:</label><select id="task-user-select" required></select></div>
                        <div><label for="task-date">Date:</label><input type="date" id="task-date" required></div>
                        <div><label for="task-description-select">Task:</label><select id="task-description-select" required><option value="">Select</option><option value="Slicing Lemons">Slicing Lemons</option><option value="Rolling Silverware">Rolling Silverware</option><option value="Polishing Glasses">Polishing Glasses</option><option value="Cleaning Beer Lines">Cleaning Beer Lines</option><option value="Cleaning Fridge Seals">Cleaning Fridge Seals</option><option value="Cleaning Glasswash">Cleaning Glasswash</option><option value="Custom Task">Custom Task</option></select></div>
                        <div id="custom-task-description-container" style="display:none;"><label for="custom-task-description">Custom:</label><input type="text" id="custom-task-description"></div>
                        <div><label for="task-repeat-days">Repeat (days):</label><input type="number" id="task-repeat-days" value="1" min="1" max="7"></div>
                        <button type="submit">Add Task</button>
                    </form>
                </div>
                <div class="admin-section">
                    <h3>Current Daily Tasks</h3>
                    <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;"><div><label for="view-task-user-select">Staff:</label><select id="view-task-user-select"></select></div><div><label for="view-task-date">Date:</label><input type="date" id="view-task-date"></div></div>
                    <ul id="admin-view-tasks-list"><li class="no-data">...</li></ul>
                </div>
                <div class="admin-section" id="holiday-management-section">
                    <h3>Manage Holidays</h3>
                    <form id="add-holiday-form">
                        <div><label for="holiday-name-input">Name/Reason:</label><input type="text" id="holiday-name-input" required></div>
                        <div><label for="holiday-start-date-input">Start Date:</label><input type="date" id="holiday-start-date-input" required></div>
                        <div><label for="holiday-end-date-input">End Date:</label><input type="date" id="holiday-end-date-input" required></div>
                        <div><label for="holiday-staff-select">Assign To:</label><select id="holiday-staff-select" required><option value="__BUSINESS__">Business (All)</option></select></div>
                        <button type="submit" id="add-holiday-btn">Add Holiday</button>
                    </form>
                    <h4>Current Holidays</h4><ul id="admin-holiday-list"><li class="no-data">...</li></ul>
                </div>
                <div class="admin-section">
                    <h3>Shift Attendance</h3>
                    <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;"><div><label for="attendance-date">Date:</label><input type="date" id="attendance-date"></div></div>
                    <ul id="admin-attendance-list"><li class="no-data">...</li></ul>
                </div>
                <div class="admin-section">
                    <h3>Task Overview</h3>
                    <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;"><div><label for="task-overview-date">Date:</label><input type="date" id="task-overview-date"></div><div><label for="task-status-filter">Status:</label><select id="task-status-filter"><option value="all">All</option><option value="completed">Completed</option><option value="pending">Pending</option><option value="overdue">Overdue</option></select></div></div>
                    <ul id="admin-task-overview-list"><li class="no-data">...</li></ul>
                </div>
            </section>
        </main>
        <footer><p>© <span id="current-year"></span> Staff Rota & Task Checklist.</p></footer>
    </div>
    <div id="toast-container"></div>

    <script>
        // --- DOM Elements ---
        const landingPage = document.getElementById('landing-page'), staffIconsContainer = document.getElementById('staff-icons-container'), appContainer = document.getElementById('app-container');
        const userInfoSpan = document.getElementById('user-info'), adminToggleButton = document.getElementById('admin-toggle-btn'), signOutButton = document.getElementById('sign-out-btn');
        const navButtons = document.querySelectorAll('.nav-buttons button'), mainSections = document.querySelectorAll('main section');
        const homeView = document.getElementById('home-view'), clockStatusBannerHome = document.getElementById('clock-status-banner-home'), clockStatusTextHome = document.getElementById('clock-status-text-home');
        const clockInOutBtnHome = document.getElementById('clock-in-out-btn-home'), whosWorkingHolidayMessage = document.getElementById('whos-working-holiday-message'), whosWorkingGrid = document.querySelector('#home-view .who-is-working-grid');
        const fohWorkingList = document.getElementById('foh-working-list'), bohWorkingList = document.getElementById('boh-working-list'), adminWorkingList = document.getElementById('admin-working-list');
        const homeTaskList = document.getElementById('home-task-list'), messageList = document.getElementById('message-list'), messageInputForm = document.getElementById('message-input-form'), messageTextarea = document.getElementById('message-text');
        const myTasksView = document.getElementById('my-tasks-view'), currentDayInfo = document.getElementById('current-day-info'), taskList = document.getElementById('task-list');
        const navMyAvailability = document.getElementById('nav-my-availability'), myAvailabilityView = document.getElementById('my-availability-view'), prevWeekAvailabilityBtn = document.getElementById('prev-week-availability-btn');
        const nextWeekAvailabilityBtn = document.getElementById('next-week-availability-btn'), currentAvailabilityWeekDisplay = document.getElementById('current-availability-week'), availabilityGrid = document.getElementById('availability-grid');
        const weeklyRotaView = document.getElementById('weekly-rota-view'), rotaGrid = document.querySelector('#weekly-rota-view .rota-grid');
        const calendarView = document.getElementById('calendar-view'), prevMonthBtn = document.getElementById('prev-month-btn'), nextMonthBtn = document.getElementById('next-month-btn');
        const currentMonthYearDisplay = document.getElementById('current-month-year'), calendarGridElement = document.querySelector('#calendar-view .calendar-grid'), calendarRoleFilter = document.getElementById('calendar-role-filter');
        const adminView = document.getElementById('admin-view'), assignShiftForm = document.getElementById('assign-shift-form'), shiftUserSelect = document.getElementById('shift-user-select');
        const shiftDateInput = document.getElementById('shift-date'), shiftTypeSelect = document.getElementById('shift-type-select'), customShiftInputContainer = document.getElementById('custom-shift-input-container');
        const customShiftTypeInput = document.getElementById('custom-shift-type'), shiftRepeatDaysInput = document.getElementById('shift-repeat-days'), staffAvailabilityDisplayAdmin = document.getElementById('staff-availability-display-admin');
        const viewShiftUserSelect = document.getElementById('view-shift-user-select'), viewShiftDateInput = document.getElementById('view-shift-date'), adminAssignedShiftsList = document.getElementById('admin-assigned-shifts');
        const assignTaskForm = document.getElementById('assign-task-form'), taskUserSelect = document.getElementById('task-user-select'), taskDateInput = document.getElementById('task-date');
        const taskDescriptionSelect = document.getElementById('task-description-select');
        const customTaskDescriptionContainer = document.getElementById('custom-task-description-container'); // Corrected
        const customTaskDescriptionInput = document.getElementById('custom-task-description'), taskRepeatDaysInput = document.getElementById('task-repeat-days');
        const viewTaskUserSelect = document.getElementById('view-task-user-select'), viewTaskDateInput = document.getElementById('view-task-date'), adminAssignedTasksList = document.getElementById('admin-view-tasks-list');
        const addHolidayForm = document.getElementById('add-holiday-form'), holidayNameInput = document.getElementById('holiday-name-input'), holidayStartDateInput = document.getElementById('holiday-start-date-input');
        const holidayEndDateInput = document.getElementById('holiday-end-date-input'), holidayStaffSelect = document.getElementById('holiday-staff-select'), adminHolidayList = document.getElementById('admin-holiday-list');
        const adminAvailabilityCalendarSection = document.getElementById('admin-availability-calendar-section'), adminPrevMonthAvailabilityBtn = document.getElementById('admin-prev-month-availability-btn');
        const adminNextMonthAvailabilityBtn = document.getElementById('admin-next-month-availability-btn'), adminCurrentMonthYearAvailabilityDisplay = document.getElementById('admin-current-month-year-availability');
        const adminAvailabilityStaffFilter = document.getElementById('admin-availability-staff-filter'), adminAvailabilityCalendarGrid = document.getElementById('admin-availability-calendar-grid');
        const refreshAdminAvailabilityBtn = document.getElementById('refresh-admin-availability-btn');
        const attendanceDateInput = document.getElementById('attendance-date'), adminAttendanceList = document.getElementById('admin-attendance-list');
        const taskOverviewDateInput = document.getElementById('task-overview-date'), taskStatusFilter = document.getElementById('task-status-filter'), adminTaskOverviewList = document.getElementById('admin-task-overview-list');
        const adminAvailabilitySlotFilter = document.getElementById('admin-availability-slot-filter');


        const LS_KEYS = { STAFF_MEMBERS: 'staffMembers', ROTA: 'rota', DAILY_TASKS: 'dailyTasks', COMPLETED_TASKS: 'completedTasks', CLOCK_INS: 'clockIns', MESSAGE_BOARD: 'messageBoard', HOLIDAYS: 'holidays', AVAILABILITY: 'staffAvailability', CURRENT_USER_NAME: 'currentUserName', CURRENT_USER_ROLE: 'currentUserRole', IS_ADMIN_MODE: 'isAdminMode', LAST_ACTIVE_VIEW: 'lastActiveView' };
        let staffMembers = [], rota = {}, dailyTasks = {}, completedTasks = {}, clockIns = {}, messageBoard = [], holidays = [], availability = {};
        let currentUserName = '', currentUserRole = '', isAdminMode = false, currentCalendarDate = new Date(), activeViewId = 'home-view', currentAvailabilityWeekDate = new Date(), currentAdminAvailabilityCalendarDate = new Date();

        const AVAILABILITY_SLOTS = { MORNING: 'Morning (approx. 8am-12pm)', AFTERNOON: 'Afternoon (approx. 12pm-5pm)', EVENING: 'Evening (approx. 5pm-Close)', FULL_DAY: 'Full Day Available', UNAVAILABLE: 'Unavailable All Day' };
        const AVAILABILITY_SLOT_ORDER = [AVAILABILITY_SLOTS.MORNING, AVAILABILITY_SLOTS.AFTERNOON, AVAILABILITY_SLOTS.EVENING, AVAILABILITY_SLOTS.FULL_DAY, AVAILABILITY_SLOTS.UNAVAILABLE];

        function showToast(message, type = 'info', duration = 3000) { const cont = document.getElementById('toast-container'); if (!cont) return; const toast = document.createElement('div'); toast.classList.add('toast', type); toast.textContent = message; cont.appendChild(toast); void toast.offsetWidth; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, duration); }
        function loadData(key) { const d = localStorage.getItem(key); try { return d ? JSON.parse(d) : null; } catch (e) { console.error(`Err LStor ${key}:`, e); return null; } }
        function saveData(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
        function getFormattedDate(date) { return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`; }
        function addDays(date, days) { const nD = new Date(date); nD.setDate(date.getDate() + days); return nD; }
        function formatTimestampToTime(ts) { if (!ts) return 'N/A'; return new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }
        function getDisplayDate(date) { return date.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}); }
        function getWeekDays(startDate) { const wD = [], d = new Date(startDate); d.setHours(0,0,0,0); const dOW = d.getDay(), diff = d.getDate()-dOW+(dOW===0?-6:1); d.setDate(diff); for(let i=0;i<7;i++){wD.push(new Date(d));d.setDate(d.getDate()+1);} return wD;}
        function isPastEndOfDay(dateStr) { const cD=new Date(dateStr), t=new Date(); cD.setHours(23,59,59,999); t.setHours(0,0,0,0); return cD < t; }
        function getStaffMember(name) { return staffMembers.find(s => s.name === name); }
        function isCurrentUserAdmin() { return currentUserRole === 'Admin'; }
        function isDateInRange(dateToCheck, startDateStr, endDateStr) { const cT=new Date(dateToCheck).setHours(0,0,0,0), sT=new Date(startDateStr).setHours(0,0,0,0), eT=new Date(endDateStr).setHours(0,0,0,0); return cT >= sT && cT <= eT; }

        function initializeData() {
            staffMembers=loadData(LS_KEYS.STAFF_MEMBERS)||[ {name:'Jill',role:'FOH',icon:'💁‍♀️'},{name:'Alice',role:'FOH',icon:'💁‍♀️'},{name:'Callum',role:'FOH',icon:'💁‍♀️'},{name:'Jess',role:'FOH',icon:'💁‍♀️'},{name:'Danny',role:'BOH',icon:'👩‍🍳'},{name:'Neil',role:'BOH',icon:'👩‍🍳'},{name:'Terry',role:'BOH',icon:'👩‍🍳'},{name:'Richard',role:'BOH',icon:'👩‍🍳'},{name:'Johnny',role:'Admin',icon:'🤵'},{name:'Lyndsey',role:'Admin',icon:'🤵'},{name:'Collin',role:'Admin',icon:'🤵'} ];
            rota=loadData(LS_KEYS.ROTA)||{}; dailyTasks=loadData(LS_KEYS.DAILY_TASKS)||{}; completedTasks=loadData(LS_KEYS.COMPLETED_TASKS)||{}; clockIns=loadData(LS_KEYS.CLOCK_INS)||{}; messageBoard=loadData(LS_KEYS.MESSAGE_BOARD)||[]; holidays=loadData(LS_KEYS.HOLIDAYS)||[]; availability=loadData(LS_KEYS.AVAILABILITY)||{};
            currentUserName=loadData(LS_KEYS.CURRENT_USER_NAME)||''; currentUserRole=loadData(LS_KEYS.CURRENT_USER_ROLE)||''; isAdminMode=loadData(LS_KEYS.IS_ADMIN_MODE)||false; activeViewId=loadData(LS_KEYS.LAST_ACTIVE_VIEW)||'home-view';

            saveData(LS_KEYS.STAFF_MEMBERS, staffMembers); saveData(LS_KEYS.ROTA, rota); saveData(LS_KEYS.DAILY_TASKS, dailyTasks); saveData(LS_KEYS.COMPLETED_TASKS, completedTasks); saveData(LS_KEYS.CLOCK_INS, clockIns); saveData(LS_KEYS.MESSAGE_BOARD, messageBoard); saveData(LS_KEYS.HOLIDAYS, holidays); saveData(LS_KEYS.AVAILABILITY, availability); saveData(LS_KEYS.CURRENT_USER_NAME, currentUserName); saveData(LS_KEYS.CURRENT_USER_ROLE, currentUserRole); saveData(LS_KEYS.IS_ADMIN_MODE, isAdminMode); saveData(LS_KEYS.LAST_ACTIVE_VIEW, activeViewId);
        }
        function showView(viewId){mainSections.forEach(s=>{s.classList.remove('active');s.style.display='none';}); const tS=document.getElementById(viewId); if(tS){tS.classList.add('active');tS.style.display='flex';} activeViewId=viewId; saveData(LS_KEYS.LAST_ACTIVE_VIEW,activeViewId); navButtons.forEach(b=>{b.classList.remove('active');if(b.id===`nav-${viewId.replace('-view','')}`)b.classList.add('active');}); if(viewId==='home-view')renderHomePage();else if(viewId==='my-tasks-view')renderMyTasks();else if(viewId==='my-availability-view'){currentAvailabilityWeekDate = new Date(); renderMyAvailabilityView();}else if(viewId==='weekly-rota-view')renderWeeklyRota();else if(viewId==='calendar-view')renderCalendar();else if(viewId==='admin-view')renderAdminForms();}
        function renderLandingPage(){staffIconsContainer.innerHTML='';staffMembers.forEach(m=>{const iD=document.createElement('div');iD.className=`staff-icon ${m.role.toLowerCase()}`;iD.dataset.name=m.name;iD.dataset.role=m.role;iD.innerHTML=`<span class="icon-placeholder">${m.icon}</span><div class="staff-name">${m.name}</div><div class="staff-role">${m.role}</div>`;iD.addEventListener('click',()=>handleUserLogin(m.name,m.role));staffIconsContainer.appendChild(iD);});}
        function handleUserLogin(uN,uR){currentUserName=uN;currentUserRole=uR;saveData(LS_KEYS.CURRENT_USER_NAME,uN);saveData(LS_KEYS.CURRENT_USER_ROLE,uR);isAdminMode=false;saveData(LS_KEYS.IS_ADMIN_MODE,false);activeViewId='home-view';saveData(LS_KEYS.LAST_ACTIVE_VIEW,'home-view');landingPage.style.display='none';appContainer.style.display='flex';appContainer.style.animation='fadeIn 0.5s ease-out';initApp();showToast(`Welcome, ${currentUserName}!`,'success');}
        function updateHeaderUserInfo(){userInfoSpan.textContent=`${currentUserName} (${currentUserRole})`;}
        function handleSignOut(){const uN=currentUserName;saveData(LS_KEYS.CURRENT_USER_NAME,'');saveData(LS_KEYS.CURRENT_USER_ROLE,'');saveData(LS_KEYS.IS_ADMIN_MODE,false);currentUserName='';currentUserRole='';isAdminMode=false;appContainer.style.display='none';landingPage.style.display='flex';renderLandingPage();showToast(`Goodbye, ${uN}!`,'info');}
        function toggleAdminView(){if(!isCurrentUserAdmin()){showToast('Permission denied.','error');return;} isAdminMode=!isAdminMode;saveData(LS_KEYS.IS_ADMIN_MODE,isAdminMode);renderAdminToggleButton();renderUserDropdownsInApp();renderAdminForms();if(isAdminMode){showView('admin-view');showToast('Admin Mode ON.','info');}else{showView('home-view');showToast('Admin Mode OFF.','info');}}
        function renderAdminToggleButton(){if(isCurrentUserAdmin()){adminToggleButton.style.display='inline-block';adminToggleButton.textContent=isAdminMode?'Exit Admin':'Admin Mode';adminToggleButton.disabled=false;}else{adminToggleButton.style.display='none';adminToggleButton.disabled=true;if(isAdminMode){isAdminMode=false;saveData(LS_KEYS.IS_ADMIN_MODE,false);}} navButtons.forEach(b=>{if(isAdminMode){b.disabled=(b.id==='nav-my-tasks'||b.id==='nav-weekly-rota'||b.id==='nav-calendar'||b.id==='nav-my-availability');}else{b.disabled=false;}}); if(navMyAvailability){if(currentUserRole==='Admin'&&!isAdminMode){navMyAvailability.style.display='none';}else if(currentUserRole==='FOH'||currentUserRole==='BOH'){navMyAvailability.style.display='inline-block';}else{navMyAvailability.style.display='none';}}}
        function handleNavButtonClick(e){const cB=e.target;let vI;if(cB.id==='nav-home')vI='home-view';else if(cB.id==='nav-my-tasks')vI='my-tasks-view';else if(cB.id==='nav-my-availability')vI='my-availability-view';else if(cB.id==='nav-weekly-rota')vI='weekly-rota-view';else if(cB.id==='nav-calendar')vI='calendar-view';else return; if(isAdminMode&&vI!=='admin-view'&&vI!=='home-view'){showToast("Exit Admin Mode.",'info');return;} if(vI === 'my-availability-view' && currentUserRole === 'Admin' && !isAdminMode){showToast("Admins don't set availability here.",'info');return;} showView(vI);}
        function renderUserDropdownsInApp(){const sS=[shiftUserSelect,taskUserSelect,viewShiftUserSelect,viewTaskUserSelect];sS.forEach(s=>{s.innerHTML='';if(staffMembers.length===0){const o=document.createElement('option');o.value='';o.textContent='No Staff';o.disabled=true;o.selected=true;s.appendChild(o);}else{staffMembers.forEach(m=>{const o=document.createElement('option');o.value=m.name;o.textContent=`${m.name} (${m.role})`;s.appendChild(o);});s.value=(currentUserName&&staffMembers.some(st=>st.name===currentUserName))?currentUserName:(staffMembers[0]?.name||'');}});}

        function renderHomePage() {
            const today = new Date(), formattedToday = getFormattedDate(today);
            const businessHolidayToday = holidays.find(h => h.staffName === "__BUSINESS__" && isDateInRange(today, h.startDate, h.endDate));
            if (businessHolidayToday) {
                whosWorkingHolidayMessage.textContent = `Closed Today: ${businessHolidayToday.name}${businessHolidayToday.startDate !== businessHolidayToday.endDate ? ' (until ' + getDisplayDate(new Date(businessHolidayToday.endDate)) + ')' : ''}`;
                whosWorkingHolidayMessage.style.display = 'block'; whosWorkingGrid.style.display = 'none';
                fohWorkingList.innerHTML = ''; bohWorkingList.innerHTML = ''; adminWorkingList.innerHTML = '';
            } else {
                whosWorkingHolidayMessage.style.display = 'none'; whosWorkingGrid.style.display = 'grid';
                fohWorkingList.innerHTML = ''; bohWorkingList.innerHTML = ''; adminWorkingList.innerHTML = '';
                const todayRota = rota[formattedToday] || {}; let fC=0,bC=0,aC=0;
                const staffToday = staffMembers.filter(m=>{if(!isCurrentUserAdmin()&&((currentUserRole==='FOH'&&m.role==='BOH')||(currentUserRole==='BOH'&&m.role==='FOH')))return false;return true;});
                staffToday.forEach(m=>{const pHoliday=holidays.find(h=>h.staffName===m.name&&isDateInRange(today,h.startDate,h.endDate)); const sft=todayRota[m.name];let dS=sft;let iOH=false; if(pHoliday){dS=`On Holiday (${pHoliday.name.substring(0,15)}${pHoliday.name.length>15?'...':''})`;iOH=true;} if((sft&&sft!=='Off')||iOH){const iD=document.createElement('div');iD.classList.add('staff-icon',m.role.toLowerCase());if(iOH)iD.classList.add('on-holiday');iD.innerHTML=`<span class="icon-placeholder">${m.icon}</span><div class="staff-name">${m.name}</div><div class="staff-role">${dS||'N/A'}</div>`;if(m.role==='FOH'){fohWorkingList.appendChild(iD);fC++;}else if(m.role==='BOH'){bohWorkingList.appendChild(iD);bC++;}else if(m.role==='Admin'){adminWorkingList.appendChild(iD);aC++;}}});
                if(fC===0)fohWorkingList.innerHTML='<li class="no-data">No FOH.</li>';if(bC===0)bohWorkingList.innerHTML='<li class="no-data">No BOH.</li>';if(aC===0)adminWorkingList.innerHTML='<li class="no-data">No Admin.</li>';
            }
            const uCD=(clockIns[formattedToday]&&clockIns[formattedToday][currentUserName])||{};let cSM='',cBT='Clock In';clockStatusBannerHome.classList.remove('clocked-in','clocked-out');if(uCD.in&&!uCD.out){cSM=`In: ${formatTimestampToTime(uCD.in)}`;cBT='Clock Out';clockStatusBannerHome.classList.add('clocked-in');}else if(uCD.in&&uCD.out){cSM=`In: ${formatTimestampToTime(uCD.in)}, Out: ${formatTimestampToTime(uCD.out)}`;cBT='Clock In';clockStatusBannerHome.classList.add('clocked-out');}else{cSM='Not clocked in.';cBT='Clock In';clockStatusBannerHome.classList.add('clocked-out');} clockStatusTextHome.textContent=cSM;clockInOutBtnHome.textContent=cBT;
            homeTaskList.innerHTML='';const tsksToday=(dailyTasks[formattedToday]&&dailyTasks[formattedToday][currentUserName])||[];const compToday=(completedTasks[formattedToday]&&completedTasks[formattedToday][currentUserName])||{};if(tsksToday.length===0){homeTaskList.innerHTML='<li class="no-tasks">No tasks.</li>';}else{tsksToday.forEach(t=>{const li=document.createElement('li');const cD=compToday[t];const iC=!!cD;const cTS=typeof cD==='object'?cD.timestamp:null;let tS=iC?'Completed':'Pending';if(!iC&&isPastEndOfDay(formattedToday)){tS='Overdue';li.classList.add('incomplete');}else if(iC){li.classList.add('completed');} li.textContent=`${t} (${tS})`;if(cTS)li.textContent+=` @ ${formatTimestampToTime(cTS)}`;li.classList.add('task-item');homeTaskList.appendChild(li);});}
            cleanupMessages();renderMessageBoard();
        }
        function toggleClockStatus(){const t=new Date(),fT=getFormattedDate(t),n=Date.now();clockIns[fT]=clockIns[fT]||{};clockIns[fT][currentUserName]=clockIns[fT][currentUserName]||{};const uCD=clockIns[fT][currentUserName];if(!uCD.in){uCD.in=n;uCD.out=null;showToast(`${currentUserName} clocked in.`,'success');}else if(uCD.in&&!uCD.out){uCD.out=n;showToast(`${currentUserName} clocked out.`,'success');}else if(uCD.in&&uCD.out){uCD.in=n;uCD.out=null;showToast(`${currentUserName} re-clocked in.`,'info');} saveData(LS_KEYS.CLOCK_INS,clockIns);renderHomePage();renderMyTasks();if(isAdminMode)renderAdminShiftAttendance();}
        function cleanupMessages(){const thr=Date.now()-(24*60*60*1000);messageBoard=messageBoard.filter(m=>m.timestamp>thr);saveData(LS_KEYS.MESSAGE_BOARD,messageBoard);}
        function renderMessageBoard(){messageList.innerHTML='';if(messageBoard.length===0){messageList.innerHTML='<li class="no-data">No messages.</li>';return;}[...messageBoard].reverse().forEach(m=>{const li=document.createElement('li');li.innerHTML=`<span class="message-sender">${m.sender}:</span> <span class="message-text">${m.text}</span> <span class="message-timestamp">(${new Date(m.timestamp).toLocaleString()})</span>`;messageList.appendChild(li);});}
        function handleSendMessage(e){e.preventDefault();const txt=messageTextarea.value.trim();if(!txt){showToast('Msg empty.','error');return;}if(!currentUserName){showToast('Log in.','error');return;}messageBoard.push({sender:currentUserName,text:txt,timestamp:Date.now()});saveData(LS_KEYS.MESSAGE_BOARD,messageBoard);messageTextarea.value='';renderMessageBoard();showToast('Msg sent!','success',1500);}
        function renderMyTasks(){taskList.innerHTML='';const t=new Date(),fT=getFormattedDate(t);currentDayInfo.textContent=getDisplayDate(t);if(!currentUserName){taskList.innerHTML='<li class="no-tasks">Log in.</li>';return;}const tsksT=(dailyTasks[fT]&&dailyTasks[fT][currentUserName])||[];const compT=(completedTasks[fT]&&completedTasks[fT][currentUserName])||{};if(tsksT.length===0){taskList.innerHTML='<li class="no-tasks">No tasks.</li>';return;}tsksT.forEach(tsk=>{const li=document.createElement('li');li.classList.add('task-item');const tC=document.createElement('span');tC.textContent=tsk;const tCt=document.createElement('div');tCt.classList.add('task-item-controls');const cb=document.createElement('input');cb.type='checkbox';cb.dataset.taskName=tsk;cb.dataset.taskDate=fT;cb.dataset.staffName=currentUserName;const aII=document.createElement('input');aII.type='file';aII.accept='image/*';aII.style.display='none';aII.dataset.taskName=tsk;aII.dataset.taskDate=fT;aII.dataset.staffName=currentUserName;const aIB=document.createElement('button');aIB.textContent='Attach Img';aIB.classList.add('upload-image-btn');aIB.type='button';const iIS=document.createElement('span');iIS.classList.add('attached-image-info');const cD=compT[tsk];const iCp=!!cD;const cTS=typeof cD==='object'?cD.timestamp:cD;const iN=typeof cD==='object'?cD.imageName:null;if(iCp){cb.checked=true;li.classList.add('completed');aIB.style.display='none';if(iN)iIS.textContent=`Img: ${iN}`;}else if(isPastEndOfDay(fT)){li.classList.add('incomplete');}tCt.appendChild(cb);tCt.appendChild(aII);tCt.appendChild(aIB);li.appendChild(tC);li.appendChild(tCt);const tsS=document.createElement('span');tsS.classList.add('timestamp');if(cTS)tsS.textContent=formatTimestampToTime(cTS);li.appendChild(tsS);li.appendChild(iIS);taskList.appendChild(li);});}
        function handleTaskCompletionOrImageAttach(e){const tgt=e.target;if(tgt.type==='checkbox'){const{taskName,taskDate,staffName}=tgt.dataset;completedTasks[taskDate]=completedTasks[taskDate]||{};completedTasks[taskDate][staffName]=completedTasks[taskDate][staffName]||{};const exC=completedTasks[taskDate][staffName][taskName];const curI=(typeof exC==='object'&&exC!==null)?exC.imageName:null;if(tgt.checked){completedTasks[taskDate][staffName][taskName]={timestamp:Date.now(),imageName:curI};showToast(`Task "${taskName}" done.`,'success',1500);}else{delete completedTasks[taskDate][staffName][taskName];if(Object.keys(completedTasks[taskDate][staffName]).length===0)delete completedTasks[taskDate][staffName];showToast(`Task "${taskName}" pending.`,'info',1500);} saveData(LS_KEYS.COMPLETED_TASKS,completedTasks);renderHomePage();renderMyTasks();if(isAdminMode)renderAdminTaskOverview();}else if(tgt.type==='file'){const{taskName,taskDate,staffName}=tgt.dataset;const f=tgt.files[0];if(f){completedTasks[taskDate]=completedTasks[taskDate]||{};completedTasks[taskDate][staffName]=completedTasks[taskDate][staffName]||{};const curC=completedTasks[taskDate][staffName][taskName];const exTS=(typeof curC==='object'&&curC!==null)?curC.timestamp:curC;completedTasks[taskDate][staffName][taskName]={timestamp:exTS||Date.now(),imageName:f.name};saveData(LS_KEYS.COMPLETED_TASKS,completedTasks);showToast(`Img "${f.name}" saved.`,'success');renderHomePage();renderMyTasks();if(isAdminMode)renderAdminTaskOverview();}else{showToast('No img selected.','info',1500);}}}
        function renderWeeklyRota(){rotaGrid.innerHTML='';const wD=getWeekDays(new Date());wD.forEach(d=>{const fD=getFormattedDate(d);const dC=document.createElement('div');dC.classList.add('rota-day-column');dC.innerHTML=`<strong>${getDisplayDate(d)}</strong><ul></ul>`;const ul=dC.querySelector('ul');const dR=rota[fD]||{};const sD=staffMembers.filter(m=>{if(!isCurrentUserAdmin()&&((currentUserRole==='FOH'&&m.role==='BOH')||(currentUserRole==='BOH'&&m.role==='FOH')))return false;return true;}).sort((a,b)=>{ const roleOrder={'FOH':1,'BOH':2,'Admin':3}; if(roleOrder[a.role]!==roleOrder[b.role])return roleOrder[a.role]-roleOrder[b.role]; return a.name.localeCompare(b.name);});sD.forEach(m=>{const s=dR[m.name]||'Off';const li=document.createElement('li');li.textContent=`${m.name}: ${s}`;li.classList.add(m.role.toLowerCase());ul.appendChild(li);});rotaGrid.appendChild(dC);});}
        function renderCalendar(){if (!calendarGridElement) {console.error("Original calendarGridElement not found!"); return;} while(calendarGridElement.children.length>7)calendarGridElement.removeChild(calendarGridElement.lastChild);const y=currentCalendarDate.getFullYear(),m=currentCalendarDate.getMonth();currentMonthYearDisplay.textContent=currentCalendarDate.toLocaleDateString('en-US',{month:'long',year:'numeric'});const fDoM=new Date(y,m,1),lDoM=new Date(y,m+1,0);const nDiM=lDoM.getDate(),fDoW=(fDoM.getDay()+6)%7;for(let i=0;i<fDoW;i++){const eD=document.createElement('div');eD.classList.add('calendar-day');calendarGridElement.appendChild(eD);} const tF=getFormattedDate(new Date()),fR=calendarRoleFilter.value;calendarRoleFilter.querySelectorAll('option').forEach(o=>o.disabled=false);if(!isCurrentUserAdmin()){if(currentUserRole==='FOH'){calendarRoleFilter.querySelector('option[value="BOH"]').disabled=true;calendarRoleFilter.querySelector('option[value="Admin"]').disabled=true;if(fR==='BOH'||fR==='Admin')calendarRoleFilter.value='all';}else if(currentUserRole==='BOH'){calendarRoleFilter.querySelector('option[value="FOH"]').disabled=true;calendarRoleFilter.querySelector('option[value="Admin"]').disabled=true;if(fR==='FOH'||fR==='Admin')calendarRoleFilter.value='all';}}
            for(let dN=1;dN<=nDiM;dN++){const day=new Date(y,m,dN);const fD=getFormattedDate(day);const dCell=document.createElement('div');dCell.classList.add('calendar-day','current-month');if(fD===tF)dCell.classList.add('today');let hTT="",iBH=false,iPH=false;holidays.forEach(h=>{if(isDateInRange(day,h.startDate,h.endDate)){if(h.staffName==="__BUSINESS__"){iBH=true;hTT+=`${h.name} (Business)${h.startDate!==h.endDate?' to '+getDisplayDate(new Date(h.endDate)):''}\n`;}else{const sOH=getStaffMember(h.staffName);if(sOH&&(fR==='all'||fR===sOH.role||isCurrentUserAdmin()||h.staffName===currentUserName)){iPH=true;hTT+=`${h.staffName}: ${h.name}${h.startDate!==h.endDate?' to '+getDisplayDate(new Date(h.endDate)):''}\n`;}}}});if(iBH)dCell.classList.add('holiday-day');if(iPH&&!iBH)dCell.classList.add('personal-holiday-day');if(hTT)dCell.title=hTT.trim();dCell.innerHTML=`<div class="day-number">${dN}</div><ul></ul>`;const ul=dCell.querySelector('ul');if(iBH){const li=document.createElement('li');li.textContent="Business Holiday";li.style.textAlign="center";li.style.fontWeight="bold";ul.appendChild(li);}else{const dR=rota[fD]||{};const sD=staffMembers.filter(s=>{if(fR!=='all'&&s.role!==fR)return false;if(!isCurrentUserAdmin()&&((currentUserRole==='FOH'&&s.role==='BOH')||(currentUserRole==='BOH'&&s.role==='FOH')))return false;return true;}).sort((a,b)=>{ const roleOrder={'FOH':1,'BOH':2,'Admin':3}; if(roleOrder[a.role]!==roleOrder[b.role])return roleOrder[a.role]-roleOrder[b.role]; return a.name.localeCompare(b.name);});sD.forEach(mem=>{const pHFM=holidays.find(h=>h.staffName===mem.name&&isDateInRange(day,h.startDate,h.endDate));const sft=dR[mem.name];if(pHFM){const li=document.createElement('li');li.textContent=`${mem.name}: On Holiday`;li.style.backgroundColor='var(--personal-holiday-bg)';li.style.color='var(--personal-holiday-border)';li.style.borderRadius='3px';li.style.padding='2px 4px';ul.appendChild(li);}else if(sft&&sft!=='Off'){const li=document.createElement('li');li.textContent=`${mem.name}: ${sft}`;li.classList.add(mem.role.toLowerCase()+'-shift');ul.appendChild(li);}}); } calendarGridElement.appendChild(dCell);}}
        function goToPrevMonth(){currentCalendarDate.setMonth(currentCalendarDate.getMonth()-1);renderCalendar();}
        function goToNextMonth(){currentCalendarDate.setMonth(currentCalendarDate.getMonth()+1);renderCalendar();}

        function renderMyAvailabilityView(){if(!myAvailabilityView)return; if (currentUserRole !== 'FOH' && currentUserRole !== 'BOH') {myAvailabilityView.innerHTML=`<p class="info-banner">FOH/BOH staff only.</p>`;currentAvailabilityWeekDisplay.textContent='';availabilityGrid.innerHTML='';return;} availabilityGrid.innerHTML='';const wDs=getWeekDays(currentAvailabilityWeekDate);const fD=wDs[0],lD=wDs[6];currentAvailabilityWeekDisplay.textContent=`${getDisplayDate(fD)} - ${getDisplayDate(lD)}`;wDs.forEach(d=>{const fDt=getFormattedDate(d);const dC=document.createElement('div');dC.classList.add('availability-day-column');dC.innerHTML=`<strong>${getDisplayDate(d)}</strong><div class="availability-slots"></div>`;const sC=dC.querySelector('.availability-slots');const uAFD=(availability[fDt]&&availability[fDt][currentUserName])||[];AVAILABILITY_SLOT_ORDER.forEach(sV=>{const sK=Object.keys(AVAILABILITY_SLOTS).find(k=>AVAILABILITY_SLOTS[k]===sV);const cbId=`avail-${fDt}-${currentUserName}-${sK}`;const lbl=document.createElement('label');lbl.setAttribute('for',cbId);const cb=document.createElement('input');cb.type='checkbox';cb.id=cbId;cb.value=sV;cb.dataset.date=fDt;cb.dataset.user=currentUserName;cb.checked=uAFD.includes(sV);cb.addEventListener('change',handleAvailabilityChange);const spn=document.createElement('span');spn.textContent=sV;lbl.appendChild(cb);lbl.appendChild(spn);sC.appendChild(lbl);});availabilityGrid.appendChild(dC);});}
        function handleAvailabilityChange(e){const cb=e.target,d=cb.dataset.date,u=cb.dataset.user,slt=cb.value;availability[d]=availability[d]||{};availability[d][u]=availability[d][u]||[];let curS=availability[d][u];const pSC=cb.closest('.availability-slots');if(cb.checked){if(slt===AVAILABILITY_SLOTS.UNAVAILABLE){availability[d][u]=[AVAILABILITY_SLOTS.UNAVAILABLE];pSC.querySelectorAll('input[type="checkbox"]').forEach(c=>{if(c!==cb)c.checked=false;});}else if(slt===AVAILABILITY_SLOTS.FULL_DAY){availability[d][u]=curS.filter(s=>s!==AVAILABILITY_SLOTS.MORNING&&s!==AVAILABILITY_SLOTS.AFTERNOON&&s!==AVAILABILITY_SLOTS.EVENING&&s!==AVAILABILITY_SLOTS.UNAVAILABLE);if(!availability[d][u].includes(AVAILABILITY_SLOTS.FULL_DAY))availability[d][u].push(AVAILABILITY_SLOTS.FULL_DAY);pSC.querySelectorAll('input[type="checkbox"]').forEach(c=>{if(c.value===AVAILABILITY_SLOTS.MORNING||c.value===AVAILABILITY_SLOTS.AFTERNOON||c.value===AVAILABILITY_SLOTS.EVENING||c.value===AVAILABILITY_SLOTS.UNAVAILABLE)c.checked=false;});}else if(slt===AVAILABILITY_SLOTS.MORNING||slt===AVAILABILITY_SLOTS.AFTERNOON||slt===AVAILABILITY_SLOTS.EVENING){availability[d][u]=curS.filter(s=>s!==AVAILABILITY_SLOTS.UNAVAILABLE&&s!==AVAILABILITY_SLOTS.FULL_DAY);if(!availability[d][u].includes(slt))availability[d][u].push(slt);pSC.querySelectorAll('input[type="checkbox"]').forEach(c=>{if(c.value===AVAILABILITY_SLOTS.UNAVAILABLE||c.value===AVAILABILITY_SLOTS.FULL_DAY)c.checked=false;});}else{if(!availability[d][u].includes(slt))availability[d][u].push(slt);}}else{availability[d][u]=curS.filter(s=>s!==slt);} if(availability[d][u].length===0){delete availability[d][u];if(Object.keys(availability[d]).length===0)delete availability[d];} saveData(LS_KEYS.AVAILABILITY,availability);showToast('Availability updated.','success',1000);if(isAdminMode&&shiftUserSelect.value===u&&shiftDateInput.value===d)displayStaffAvailabilityInAdmin(u,d);}
        function changeAvailabilityWeek(dir){const nD=new Date(currentAvailabilityWeekDate);nD.setDate(nD.getDate()+(7*dir));currentAvailabilityWeekDate=nD;renderMyAvailabilityView();}
        function displayStaffAvailabilityInAdmin(sN,d){if(!staffAvailabilityDisplayAdmin)return;const sA=(availability[d]&&availability[d][sN])||[];if(sA.length>0){staffAvailabilityDisplayAdmin.innerHTML=`<strong>Availability for ${sN} on ${getDisplayDate(new Date(d))}:</strong> ${sA.join(', ')}`;staffAvailabilityDisplayAdmin.style.display='block';}else{staffAvailabilityDisplayAdmin.innerHTML=`<strong>Availability for ${sN} on ${getDisplayDate(new Date(d))}:</strong> Not specified.`;staffAvailabilityDisplayAdmin.style.display='block';}}
        function clearStaffAvailabilityDisplayAdmin(){if(staffAvailabilityDisplayAdmin){staffAvailabilityDisplayAdmin.style.display='none';staffAvailabilityDisplayAdmin.innerHTML='';}}
        function populateHolidayStaffSelect(){holidayStaffSelect.innerHTML='<option value="__BUSINESS__">Business (All)</option>';staffMembers.forEach(m=>{const o=document.createElement('option');o.value=m.name;o.textContent=m.name;holidayStaffSelect.appendChild(o);});}
        function populateAdminAvailabilityStaffFilter() { if (!adminAvailabilityStaffFilter) return; adminAvailabilityStaffFilter.innerHTML = '<option value="all">All FOH/BOH</option><option value="FOH">All FOH Staff</option><option value="BOH">All BOH Staff</option>'; /* Individual staff can be added here if needed */ }
        function populateAdminAvailabilitySlotFilter() { if (!adminAvailabilitySlotFilter) return; adminAvailabilitySlotFilter.innerHTML = '<option value="all_slots">All Slots</option>'; AVAILABILITY_SLOT_ORDER.forEach(slotValue => { const option = document.createElement('option'); option.value = slotValue; let displayName = slotValue.substring(0, slotValue.indexOf('(') > 0 ? slotValue.indexOf('(') -1 : slotValue.length); if (slotValue === AVAILABILITY_SLOTS.UNAVAILABLE) displayName = "Unavailable"; if (slotValue === AVAILABILITY_SLOTS.FULL_DAY) displayName = "Full Day"; option.textContent = displayName; adminAvailabilitySlotFilter.appendChild(option); }); }
        function renderAdminAvailabilityCalendar() { if (!adminAvailabilityCalendarGrid || !adminCurrentMonthYearAvailabilityDisplay) { console.warn("Admin availability calendar elements not found."); return; } while (adminAvailabilityCalendarGrid.children.length > 7) { adminAvailabilityCalendarGrid.removeChild(adminAvailabilityCalendarGrid.lastChild); } const year = currentAdminAvailabilityCalendarDate.getFullYear(); const month = currentAdminAvailabilityCalendarDate.getMonth(); adminCurrentMonthYearAvailabilityDisplay.textContent = currentAdminAvailabilityCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }); const firstDayOfMonth = new Date(year, month, 1); const lastDayOfMonth = new Date(year, month + 1, 0); const numDaysInMonth = lastDayOfMonth.getDate(); const firstDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7; for (let i = 0; i < firstDayOfWeek; i++) { const emptyDay = document.createElement('div'); emptyDay.classList.add('calendar-day'); adminAvailabilityCalendarGrid.appendChild(emptyDay); } const todayFormatted = getFormattedDate(new Date()); const selectedStaffRoleFilter = adminAvailabilityStaffFilter.value; const selectedSlotFilter = adminAvailabilitySlotFilter.value;
            for (let dayNum = 1; dayNum <= numDaysInMonth; dayNum++) { const currentDate = new Date(year, month, dayNum); const formattedDate = getFormattedDate(currentDate); const dayCell = document.createElement('div'); dayCell.classList.add('calendar-day', 'current-month'); if (formattedDate === todayFormatted) { dayCell.classList.add('today'); } dayCell.innerHTML = `<div class="day-number">${dayNum}</div><ul></ul>`; const ul = dayCell.querySelector('ul'); let staffToConsider = staffMembers.filter(s => s.role === 'FOH' || s.role === 'BOH'); if (selectedStaffRoleFilter === 'FOH') { staffToConsider = staffToConsider.filter(s => s.role === 'FOH'); } else if (selectedStaffRoleFilter === 'BOH') { staffToConsider = staffToConsider.filter(s => s.role === 'BOH');} let foundAnyMatchingAvailability = false;
                staffToConsider.forEach(staff => { const staffAvailForDay = (availability[formattedDate] && availability[formattedDate][staff.name]) || []; const matchingSlots = staffAvailForDay.filter(slotValue => selectedSlotFilter === 'all_slots' || slotValue === selectedSlotFilter); if (matchingSlots.length > 0) { foundAnyMatchingAvailability = true; matchingSlots.forEach(slotValue => { const li = document.createElement('li'); let slotClass = '', slotShortName = slotValue; if (slotValue === AVAILABILITY_SLOTS.MORNING) { slotClass = 'avail-morning'; slotShortName = 'Morn'; } else if (slotValue === AVAILABILITY_SLOTS.AFTERNOON) { slotClass = 'avail-afternoon'; slotShortName = 'Aftn'; } else if (slotValue === AVAILABILITY_SLOTS.EVENING) { slotClass = 'avail-evening'; slotShortName = 'Eve'; } else if (slotValue === AVAILABILITY_SLOTS.FULL_DAY) { slotClass = 'avail-fullday'; slotShortName = 'Full'; } else if (slotValue === AVAILABILITY_SLOTS.UNAVAILABLE) { slotClass = 'avail-unavailable'; slotShortName = 'N/A'; } if (slotClass) li.classList.add(slotClass); li.textContent = `${staff.name.substring(0,3)}.: ${slotShortName}`; ul.appendChild(li); }); } });
                if (!foundAnyMatchingAvailability && ul.children.length === 0) { const li = document.createElement('li'); li.classList.add('no-data'); if (selectedStaffRoleFilter !== 'all' && selectedSlotFilter !== 'all_slots') { li.textContent = 'None for filter'; } else if (selectedStaffRoleFilter !== 'all') { li.textContent = 'No matching avail.'; } else if (selectedSlotFilter !== 'all_slots') { li.textContent = 'None for slot'; } else { li.textContent = 'No Avail.'; } ul.appendChild(li); } adminAvailabilityCalendarGrid.appendChild(dayCell); } }
        function adminChangeAvailabilityCalendarMonth(direction) { currentAdminAvailabilityCalendarDate.setMonth(currentAdminAvailabilityCalendarDate.getMonth() + direction); renderAdminAvailabilityCalendar(); }

        function renderAdminForms(){const tD=new Date(),fTD=getFormattedDate(tD);renderUserDropdownsInApp();populateHolidayStaffSelect(); populateAdminAvailabilityStaffFilter(); populateAdminAvailabilitySlotFilter(); const aFE=adminView.querySelectorAll('input,select,button');const dAC=!isCurrentUserAdmin();aFE.forEach(e=>e.disabled=dAC);shiftDateInput.value=fTD;taskDateInput.value=fTD;viewShiftDateInput.value=fTD;viewTaskDateInput.value=fTD;holidayStartDateInput.value=fTD;holidayEndDateInput.value=fTD;attendanceDateInput.value=fTD;taskOverviewDateInput.value=fTD;shiftTypeSelect.value='8AM-4PM';customShiftInputContainer.style.display='none';customShiftTypeInput.value='';taskDescriptionSelect.value=(taskDescriptionSelect.options[1]?taskDescriptionSelect.options[1].value:'Slicing Lemons'); customTaskDescriptionContainer.style.display='none';customTaskDescriptionInput.value='';
            viewShiftUserSelect.addEventListener('change',()=>{if(viewShiftUserSelect.value&&viewShiftDateInput.value)displayStaffAvailabilityInAdmin(viewShiftUserSelect.value,viewShiftDateInput.value);else clearStaffAvailabilityDisplayAdmin();});
            viewShiftDateInput.addEventListener('change',()=>{if(viewShiftUserSelect.value&&viewShiftDateInput.value)displayStaffAvailabilityInAdmin(viewShiftUserSelect.value,viewShiftDateInput.value);else clearStaffAvailabilityDisplayAdmin();});
            shiftUserSelect.addEventListener('change',()=>{if(shiftUserSelect.value&&shiftDateInput.value)displayStaffAvailabilityInAdmin(shiftUserSelect.value,shiftDateInput.value);else clearStaffAvailabilityDisplayAdmin();});
            shiftDateInput.addEventListener('change',()=>{if(shiftUserSelect.value&&shiftDateInput.value)displayStaffAvailabilityInAdmin(shiftUserSelect.value,shiftDateInput.value);else clearStaffAvailabilityDisplayAdmin();});
            if(shiftUserSelect.value&&shiftDateInput.value)displayStaffAvailabilityInAdmin(shiftUserSelect.value,shiftDateInput.value);else clearStaffAvailabilityDisplayAdmin();
            renderAdminAssignedShifts();renderAdminAssignedTasks();renderAdminHolidayList();renderAdminAvailabilityCalendar();renderAdminShiftAttendance();renderAdminTaskOverview();}
        function handleShiftTypeChange(){customShiftInputContainer.style.display=shiftTypeSelect.value==='custom'?'block':'none';customShiftTypeInput.required=shiftTypeSelect.value==='custom';if(shiftTypeSelect.value!=='custom')customShiftTypeInput.value='';}
        function handleTaskDescriptionChange(){customTaskDescriptionContainer.style.display=taskDescriptionSelect.value==='Custom Task'?'block':'none';customTaskDescriptionInput.required=taskDescriptionSelect.value==='Custom Task';if(taskDescriptionSelect.value!=='Custom Task')customTaskDescriptionInput.value='';}
        function handleAssignShift(e){e.preventDefault();if(!isCurrentUserAdmin()){showToast('Permission denied.','error');return;}const stf=shiftUserSelect.value,bD=new Date(shiftDateInput.value);const rD=parseInt(shiftRepeatDaysInput.value);let sT=shiftTypeSelect.value==='custom'?customShiftTypeInput.value.trim():shiftTypeSelect.value.trim();if(!stf||!shiftDateInput.value||!sT||isNaN(rD)||rD<1||rD>7){showToast('Invalid input.','error');return;}let aM=0,hC=0;for(let i=0;i<rD;i++){const cD=addDays(bD,i),fD=getFormattedDate(cD);const bH=holidays.find(h=>h.staffName==="__BUSINESS__"&&isDateInRange(cD,h.startDate,h.endDate));if(bH){showToast(`No shift: ${fD} is Business Holiday (${bH.name}).`,'warning',4000);hC++;continue;}const pH=holidays.find(h=>h.staffName===stf&&isDateInRange(cD,h.startDate,h.endDate));if(pH){showToast(`No shift: ${stf} on holiday (${pH.name}) on ${fD}.`,'warning',4000);hC++;continue;}rota[fD]=rota[fD]||{};rota[fD][stf]=sT;aM++;} if(aM>0){saveData(LS_KEYS.ROTA,rota);showToast(`Shift for ${aM} day(s).`,'success');}else if(hC===0){showToast('Shift exists or no valid days.','info');} if(hC>0&&aM===0){showToast('No shifts due to holidays.','info');} renderWeeklyRota();renderCalendar();renderAdminAssignedShifts();renderHomePage();shiftTypeSelect.value='8AM-4PM';customShiftInputContainer.style.display='none';customShiftTypeInput.value='';shiftRepeatDaysInput.value='1';}
        function handleAssignTask(e){e.preventDefault();if(!isCurrentUserAdmin()){showToast('Permission denied.','error');return;}const stf=taskUserSelect.value,bD=new Date(taskDateInput.value);const rD=parseInt(taskRepeatDaysInput.value);let tDsc=taskDescriptionSelect.value==='Custom Task'?customTaskDescriptionInput.value.trim():taskDescriptionSelect.value.trim();if(!stf||!taskDateInput.value||!tDsc||isNaN(rD)||rD<1||rD>7){showToast('Invalid input.','error');return;}let aM=0;for(let i=0;i<rD;i++){const cD=addDays(bD,i),fD=getFormattedDate(cD);dailyTasks[fD]=dailyTasks[fD]||{};dailyTasks[fD][stf]=dailyTasks[fD][stf]||[];if(!dailyTasks[fD][stf].includes(tDsc)){dailyTasks[fD][stf].push(tDsc);aM++;}} if(aM>0){saveData(LS_KEYS.DAILY_TASKS,dailyTasks);showToast(`Task for ${aM} day(s).`,'success');}else{showToast('Task exists.','info');} renderHomePage();renderMyTasks();renderAdminAssignedTasks();renderAdminTaskOverview();taskDescriptionSelect.value=(taskDescriptionSelect.options[1] ? taskDescriptionSelect.options[1].value : '');customTaskDescriptionContainer.style.display='none';customTaskDescriptionInput.value='';taskRepeatDaysInput.value='1';}
        function renderAdminHolidayList(){adminHolidayList.innerHTML='';if(holidays.length===0){adminHolidayList.innerHTML='<li class="no-data">No holidays.</li>';return;}const sH=[...holidays].sort((a,b)=>new Date(a.startDate)-new Date(b.startDate)||a.staffName.localeCompare(b.staffName));sH.forEach((h,idx)=>{const li=document.createElement('li');const ass=h.staffName==="__BUSINESS__"?"Business":`Staff: ${h.staffName}`;const dR=h.startDate===h.endDate?h.startDate:`${h.startDate} to ${h.endDate}`;li.innerHTML=`<span><strong>${h.name}</strong> (${ass})<br>${dR}</span><button class="delete-btn" data-type="holiday" data-index="${idx}" ${isCurrentUserAdmin()?'':'disabled'}>Del</button>`;adminHolidayList.appendChild(li);});}
        function handleAddHoliday(e){e.preventDefault();if(!isCurrentUserAdmin()){showToast('Permission denied.','error');return;}const n=holidayNameInput.value.trim(),sD=holidayStartDateInput.value,eD=holidayEndDateInput.value,sN=holidayStaffSelect.value;if(!n||!sD||!eD||!sN){showToast('All fields required.','error');return;}if(new Date(eD)<new Date(sD)){showToast('End before start.','error');return;}holidays.push({name:n,startDate:sD,endDate:eD,staffName:sN});saveData(LS_KEYS.HOLIDAYS,holidays);renderAdminHolidayList();renderCalendar();renderHomePage();showToast(`Holiday "${n}" added.`,'success');holidayNameInput.value='';holidayStartDateInput.value=getFormattedDate(new Date());holidayEndDateInput.value=getFormattedDate(new Date());}
        function handleDeleteAdminItem(e){if(!e.target.classList.contains('delete-btn')||e.target.disabled)return;const iT=e.target.dataset.type,stf=e.target.dataset.staff,d=e.target.dataset.date;if(iT==='task'){const tsk=e.target.dataset.task;if(confirm(`Del task "${tsk}" for ${stf} on ${d}?`)){if(dailyTasks[d]&&dailyTasks[d][stf]){dailyTasks[d][stf]=dailyTasks[d][stf].filter(t=>t!==tsk);if(dailyTasks[d][stf].length===0)delete dailyTasks[d][stf];if(Object.keys(dailyTasks[d]).length===0)delete dailyTasks[d];saveData(LS_KEYS.DAILY_TASKS,dailyTasks);if(completedTasks[d]?.[stf]?.[tsk]){delete completedTasks[d][stf][tsk]; if(Object.keys(completedTasks[d][stf]).length===0)delete completedTasks[d][stf]; if(Object.keys(completedTasks[d]).length===0)delete completedTasks[d]; saveData(LS_KEYS.COMPLETED_TASKS,completedTasks);}renderAdminAssignedTasks();renderHomePage();renderMyTasks();renderAdminTaskOverview();showToast('Task deleted.','success');}}}else if(iT==='shift'){if(confirm(`Del shift for ${stf} on ${d}?`)){if(rota[d]?.[stf]){delete rota[d][stf];if(Object.keys(rota[d]).length===0)delete rota[d];saveData(LS_KEYS.ROTA,rota);renderAdminAssignedShifts();renderWeeklyRota();renderCalendar();renderHomePage();showToast('Shift deleted.','success');}}}else if(iT==='holiday'){const idx=parseInt(e.target.dataset.index,10);if(isNaN(idx)||idx<0||idx>=holidays.length){showToast('Error deleting.','error');return;}const h=holidays[idx];if(confirm(`Del holiday "${h.name}" (${h.startDate} to ${h.endDate})?`)){holidays.splice(idx,1);saveData(LS_KEYS.HOLIDAYS,holidays);renderAdminHolidayList();renderCalendar();renderHomePage();showToast('Holiday deleted.','success');}}}
        function renderAdminAssignedShifts(){const stf=viewShiftUserSelect.value,d=viewShiftDateInput.value;adminAssignedShiftsList.innerHTML='';if(!stf||!d){adminAssignedShiftsList.innerHTML='<li class="no-data">Select.</li>';return;}const s=(rota[d]||{})[stf];if(s){const li=document.createElement('li');li.innerHTML=`<span>${stf}: ${s}</span><button class="delete-btn" data-type="shift" data-staff="${stf}" data-date="${d}" ${isCurrentUserAdmin()?'':'disabled'}>Del</button>`;adminAssignedShiftsList.appendChild(li);}else{adminAssignedShiftsList.innerHTML='<li class="no-data">No shift.</li>';}}
        function renderAdminAssignedTasks(){const stf=viewTaskUserSelect.value,d=viewTaskDateInput.value;adminAssignedTasksList.innerHTML='';if(!stf||!d){adminAssignedTasksList.innerHTML='<li class="no-data">Select.</li>';return;}const tsks=((dailyTasks[d]||{})[stf])||[];if(tsks.length>0){tsks.forEach(t=>{const li=document.createElement('li');li.innerHTML=`<span>${t}</span><button class="delete-btn" data-type="task" data-staff="${stf}" data-date="${d}" data-task="${t}" ${isCurrentUserAdmin()?'':'disabled'}>Del</button>`;adminAssignedTasksList.appendChild(li);});}else{adminAssignedTasksList.innerHTML='<li class="no-data">No tasks.</li>';}}
        function renderAdminShiftAttendance(){const d=attendanceDateInput.value;adminAttendanceList.innerHTML='';if(!d){adminAttendanceList.innerHTML='<li class="no-data">Select date.</li>';return;}const aFD=clockIns[d]||{},sFD=rota[d]||{};let hD=false;const sS=[...staffMembers].sort((a,b)=>{ const roleOrder={'Admin':1,'FOH':2,'BOH':3}; if(roleOrder[a.role]!==roleOrder[b.role])return roleOrder[a.role]-roleOrder[b.role]; return a.name.localeCompare(b.name); });sS.forEach(m=>{const s=sFD[m.name],cD=aFD[m.name]||{};if(s){hD=true;const li=document.createElement('li');let sT='',sC='';if(cD.in&&!cD.out){sT=`In: ${formatTimestampToTime(cD.in)}`;sC='completed';}else if(cD.in&&cD.out){sT=`In: ${formatTimestampToTime(cD.in)}, Out: ${formatTimestampToTime(cD.out)}`;sC='completed';}else if(isPastEndOfDay(d)&&s!=='Off'){sT='Missed?';sC='overdue';}else{sT='Not In';sC='pending';}li.classList.add(sC);li.innerHTML=`<span>${m.name} (${s}): ${sT}</span>`;adminAttendanceList.appendChild(li);}});if(!hD)adminAttendanceList.innerHTML='<li class="no-data">No shifts.</li>';}
        function renderAdminTaskOverview(){const d=taskOverviewDateInput.value,f=taskStatusFilter.value;adminTaskOverviewList.innerHTML='';if(!d){adminTaskOverviewList.innerHTML='<li class="no-data">Select.</li>';return;}const tsksFD=dailyTasks[d]||{},cmpFD=completedTasks[d]||{};let hD=false;staffMembers.forEach(m=>{const sT=tsksFD[m.name]||[],sC=cmpFD[m.name]||{};sT.forEach(t=>{hD=true;const iC=!!sC[t];let st=iC?'completed':(isPastEndOfDay(d)?'overdue':'pending');if(f==='all'||f===st){const li=document.createElement('li');li.classList.add('admin-task-overview-item',st);let det=`${m.name}: ${t} (${st})`;if(iC&&typeof sC[t]==='object'){if(sC[t].timestamp)det+=` @ ${formatTimestampToTime(sC[t].timestamp)}`;if(sC[t].imageName)det+=` [Img: ${sC[t].imageName}]`;}li.innerHTML=`<span>${det}</span>`;adminTaskOverviewList.appendChild(li);}});});if(!hD)adminTaskOverviewList.innerHTML='<li class="no-data">No tasks.</li>';}

        function initApp(){updateHeaderUserInfo();renderAdminToggleButton();renderUserDropdownsInApp();showView(activeViewId);document.getElementById('current-year').textContent=new Date().getFullYear();
            adminToggleButton.addEventListener('click',toggleAdminView);signOutButton.addEventListener('click',handleSignOut);clockInOutBtnHome.addEventListener('click',toggleClockStatus);navButtons.forEach(b=>b.addEventListener('click',handleNavButtonClick));taskList.addEventListener('change',handleTaskCompletionOrImageAttach);taskList.addEventListener('click',(e)=>{if(e.target.classList.contains('upload-image-btn'))e.target.previousElementSibling.click();});taskList.addEventListener('input',(e)=>{if(e.target.type==='file')handleTaskCompletionOrImageAttach(e);});messageInputForm.addEventListener('submit',handleSendMessage);shiftTypeSelect.addEventListener('change',handleShiftTypeChange);taskDescriptionSelect.addEventListener('change',handleTaskDescriptionChange);assignShiftForm.addEventListener('submit',handleAssignShift);assignTaskForm.addEventListener('submit',handleAssignTask);viewShiftUserSelect.addEventListener('change',renderAdminAssignedShifts);viewShiftDateInput.addEventListener('change',renderAdminAssignedShifts);adminAssignedShiftsList.addEventListener('click',handleDeleteAdminItem);viewTaskUserSelect.addEventListener('change',renderAdminAssignedTasks);viewTaskDateInput.addEventListener('change',renderAdminAssignedTasks);adminAssignedTasksList.addEventListener('click',handleDeleteAdminItem);addHolidayForm.addEventListener('submit',handleAddHoliday);adminHolidayList.addEventListener('click',handleDeleteAdminItem);attendanceDateInput.addEventListener('change',renderAdminShiftAttendance);taskOverviewDateInput.addEventListener('change',renderAdminTaskOverview);taskStatusFilter.addEventListener('change',renderAdminTaskOverview);
            if(prevWeekAvailabilityBtn)prevWeekAvailabilityBtn.addEventListener('click',()=>changeAvailabilityWeek(-1));if(nextWeekAvailabilityBtn)nextWeekAvailabilityBtn.addEventListener('click',()=>changeAvailabilityWeek(1));
            if(adminPrevMonthAvailabilityBtn) adminPrevMonthAvailabilityBtn.addEventListener('click', () => adminChangeAvailabilityCalendarMonth(-1));
            if(adminNextMonthAvailabilityBtn) adminNextMonthAvailabilityBtn.addEventListener('click', () => adminChangeAvailabilityCalendarMonth(1));
            if(adminAvailabilityStaffFilter) adminAvailabilityStaffFilter.addEventListener('change', renderAdminAvailabilityCalendar);
            if(adminAvailabilitySlotFilter) adminAvailabilitySlotFilter.addEventListener('change', renderAdminAvailabilityCalendar);
            if(refreshAdminAvailabilityBtn) refreshAdminAvailabilityBtn.addEventListener('click', () => { availability = loadData(LS_KEYS.AVAILABILITY) || {}; renderAdminAvailabilityCalendar(); if (shiftUserSelect.value && shiftDateInput.value) { displayStaffAvailabilityInAdmin(shiftUserSelect.value, shiftDateInput.value); } showToast('Availability data refreshed for admin view.', 'info'); });
            if(isAdminMode){renderAdminShiftAttendance();renderAdminTaskOverview();renderAdminHolidayList(); renderAdminAvailabilityCalendar();}
            const delBtnsAdm=adminView.querySelectorAll('.delete-btn');const disDelBtns=!isCurrentUserAdmin();delBtnsAdm.forEach(b=>b.disabled=disDelBtns);prevMonthBtn.addEventListener('click',goToPrevMonth);nextMonthBtn.addEventListener('click',goToNextMonth);calendarRoleFilter.addEventListener('change',renderCalendar);
        }
        document.addEventListener('DOMContentLoaded',()=>{initializeData();
            // if('serviceWorker'in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('./service-worker.js').then(r=>console.log('SW registered.')).catch(e=>console.error('SW reg fail:',e));});}
            if(currentUserName&&staffMembers.some(s=>s.name===currentUserName)){landingPage.style.display='none';appContainer.style.display='flex';initApp();if(isAdminMode&&activeViewId==='admin-view'){renderAdminForms();}}else{landingPage.style.display='flex';appContainer.style.display='none';renderLandingPage();}});
    </script>
</body>
</html>
