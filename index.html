<!DOCTYPE html>
<html lang="en" x-data="app()" x-cloak>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Staff Rota & Tasks</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js for interactivity -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    /* Prevent FOUC (Flash Of Unstyled Content) with x-cloak */
    [x-cloak] { display: none !important; }

    /*
     * Custom CSS Styles
     * Modern, minimalist design with mobile-first responsiveness.
     * Color scheme: Black, white, dark grey, purple highlights.
     */

    :root {
      --primary-bg: #f4f4f4; /* Lighter grey for overall background */
      --secondary-bg: #ffffff; /* White for main content cards */
      --text-color: #333;
      --light-grey: #e0e0e0;
      --dark-grey: #444;
      --header-bg: #222; /* Darker header */
      --accent-color: #6a0dad; /* Primary Purple */
      --accent-hover: #8a2be2; /* Lighter Purple for hover */
      --border-color: #ddd;
      --incomplete-bg: #ffe0b2; /* Light orange for incomplete */
      --incomplete-border: #ff8c00; /* Darker orange for incomplete */
      --completed-bg: #e6ffe6; /* Light green for completed */
      --completed-border: #4CAF50; /* Green for completed */
      --delete-btn-bg: #dc3545; /* Red for delete */
      --delete-btn-hover: #c82333; /* Darker red */

      /* Role Colors */
      --foh-color: #007bff; /* Blue for Front of House */
      --boh-color: #28a745; /* Green for Back of House */
      --admin-color: #6c757d; /* Grey for Admin */
      --foh-light-bg: #e0f2f7; /* Light blue for FOH shifts */
      --boh-light-bg: #e6ffe6; /* Light green for BOH shifts */
      --admin-light-bg: #f0f0f0; /* Light grey for Admin shifts */
    }

    /* Basic Reset */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', sans-serif;
      line-height: 1.6; /* Ensure line height is defined */
      background: var(--primary-bg);
      color: var(--text-color);
      display: flex; flex-direction: column;
      min-height: 100vh; padding: 10px;
      align-items: center; /* Center horizontally */
      justify-content: center; /* Center vertically */
    }

    /* Landing Page */
    #landing-page {
      background: var(--secondary-bg);
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      margin: auto; padding: 40px;
      text-align: center;
      max-width: 600px;
      width: 100%;
      display: flex; flex-direction: column;
      animation: fadeIn 0.5s ease-out;
    }
    #landing-page h1 { color: var(--accent-color); font-size: 2em; margin-bottom: 25px; }
    #landing-page p  { color: var(--dark-grey); margin-bottom: 25px; font-size: 1.1em; }
    #staff-icons-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 20px; margin-bottom: 30px;
      width: 100%;
      min-height: 120px; /* Ensure space for icons even if not loaded */
      align-items: start;
      justify-items: center;
    }
    .staff-icon {
      background: var(--light-grey);
      border-radius: 12px;
      padding: 15px 5px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      min-height: 120px;
      min-width: 100px;
      animation: pulse 2s infinite ease-in-out;
      transition: all 0.2s ease; /* Ensure hover and selected transitions */
    }
    .staff-icon:hover {
      background: var(--accent-hover);
      transform: translateY(-5px) scale(1.03);
      color: #fff;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    .staff-icon.selected { /* Selected class is still used for visual feedback on click before page transition */
      background-color: var(--accent-color);
      color: white;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transform: translateY(-2px) scale(1.02);
      border: 2px solid white;
      animation: none; /* Stop pulse on selected icon */
    }
    .icon-placeholder { font-size: 3em; margin-bottom: 8px; line-height: 1; }
    .staff-icon.foh .icon-placeholder { color: var(--foh-color); }
    .staff-icon.boh .icon-placeholder { color: var(--boh-color); }
    .staff-icon.admin .icon-placeholder { color: var(--admin-color); }
    .staff-icon.selected .icon-placeholder { color: white; } /* Keep icon white when selected */
    .staff-name {
      font-weight: bold; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      text-align: center; max-width: 90%;
    }
    .staff-role {
      font-size: 0.85em; padding: 3px 8px; border-radius: 4px; background: rgba(0,0,0,0.1);
      color: var(--dark-grey);
    }
    .staff-icon.selected .staff-role {
      background-color: rgba(255,255,255,0.2);
      color: white;
    }

    /* Login button (hidden as per request) */
    #login-button { display: none; }

    /* Pulse animation */
    @keyframes pulse {
      0%   { transform: scale(1); }
      50%  { transform: scale(1.03); } /* Slightly less aggressive pulse */
      100% { transform: scale(1); }
    }

    /* Fade-in */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Main App Container (hidden by default) */
    #app-container {
      display: none;
      flex-direction: column;
      background: var(--secondary-bg);
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      margin: 20px auto; max-width: 960px;
      width: 100%; /* Ensure it takes full width within body padding */
      min-height: 90vh;
      overflow: hidden;
    }

    /* Header */
    header {
      background: var(--header-bg);
      color: #fff;
      padding: 15px 25px;
      display: flex;
      flex-direction: column; /* Default to column for mobile */
      align-items: flex-start;
      gap: 15px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    header h1 {
      font-size: 1.8em;
      color: var(--accent-hover);
      letter-spacing: 0.5px;
      margin-bottom: 0; /* Remove default margin */
    }

    header .top-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      width: 100%;
      align-items: center;
      justify-content: flex-start;
    }

    header .nav-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      width: 100%;
    }

    header label {
      color: var(--light-grey);
      font-weight: bold;
      white-space: nowrap;
      display: flex;
      align-items: center;
    }

    header #user-info {
      font-weight: bold;
      color: var(--light-grey);
      font-size: 1.1em;
      white-space: nowrap;
      margin-right: 10px;
    }

    header button {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      font-size: 0.95em;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
      white-space: nowrap;
    }

    header #sign-out-btn {
      background-color: #6c757d; /* Grey for sign out */
      color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    }
    header #sign-out-btn:hover {
      background-color: #5a6268;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }


    header button:not(#sign-out-btn) { /* Apply accent styles to other buttons */
      background-color: var(--accent-color);
      color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    }

    header button:not(#sign-out-btn):hover {
      background-color: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    header button:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    header .nav-buttons button.active {
      background-color: var(--accent-hover);
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
      transform: translateY(0);
    }
    header .nav-buttons button:disabled {
      background-color: #555;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Main Content Styling */
    main {
      padding: 25px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto; /* Allow scrolling for main content */
      -ms-overflow-style: none; /* IE and Edge */
      scrollbar-width: none; /* Firefox */
    }
    main::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }

    section {
      background-color: var(--secondary-bg);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      display: none; /* Hidden by default, JS toggles visibility */
      flex-direction: column;
      flex-grow: 1;
      transition: opacity 0.3s ease-in-out; /* Smooth transition for section display */
    }

    section.active {
      display: flex;
      opacity: 1;
    }

    h2 {
      color: var(--accent-color);
      margin-bottom: 20px;
      font-size: 1.6em;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--light-grey);
      text-align: center;
    }

    h3 {
      color: var(--dark-grey);
      margin-top: 25px;
      margin-bottom: 12px;
      font-size: 1.2em;
    }

    /* Banners/Messages */
    .info-banner {
      background-color: rgba(106, 13, 173, 0.1); /* Light purple background */
      color: var(--accent-color);
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 0.95em;
      text-align: center;
      border: 1px solid rgba(106, 13, 173, 0.2);
    }
    .status-banner {
        background-color: var(--light-grey);
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 0.95em;
        text-align: center;
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 15px;
    }
    .status-banner.clocked-in {
        background-color: var(--completed-bg);
        border-color: var(--completed-border);
        color: var(--boh-color);
    }
    .status-banner.clocked-out {
        background-color: var(--incomplete-bg);
        border-color: var(--incomplete-border);
        color: var(--incomplete-border);
    }
    .status-banner button {
        flex-shrink: 0; /* Prevent button from shrinking */
        padding: 8px 15px;
        font-size: 0.9em;
        border-radius: 6px;
        transition: background-color 0.2s ease;
    }
    .status-banner.clocked-in button {
        background-color: var(--incomplete-border); /* Red-orange to clock out */
        color: white;
    }
    .status-banner.clocked-in button:hover {
        background-color: #e07b00;
    }
    .status-banner.clocked-out button {
        background-color: var(--boh-color); /* Green to clock in */
        color: white;
    }
    .status-banner.clocked-out button:hover {
        background-color: #218838;
    }



    /* Rota View */
    .rota-grid-container {
      overflow-x: auto;
      padding-bottom: 10px;
    }

    #weekly-rota-view .rota-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(140px, 1fr)); /* Responsive columns */
      gap: 12px;
      min-width: 1000px; /* Ensure it's wide enough to scroll if necessary */
      text-align: center;
    }

    #home-view .who-is-working-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* Responsive columns */
        gap: 12px;
        margin-bottom: 20px;
    }

    .rota-day-column {
      background-color: var(--light-grey);
      border-radius: 8px;
      padding: 15px 10px;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }

    .working-staff-column {
        background-color: var(--light-grey);
        border-radius: 8px;
        padding: 10px 5px; /* Slightly less padding */
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
    }
    .working-staff-column strong {
        display: block;
        margin-bottom: 5px;
        color: var(--accent-color);
        font-size: 1em;
    }

    .rota-day-column strong {
      display: block;
      margin-bottom: 10px;
      color: var(--accent-color);
      font-size: 1em;
    }

    .rota-day-column ul, .working-staff-column ul {
      list-style: none;
      padding: 0;
      width: 100%;
    }

    .rota-day-column li { /* generic list item for rota */
      background-color: var(--secondary-bg);
      padding: 8px 5px;
      margin-bottom: 5px;
      border-radius: 5px;
      font-size: 0.9em;
      border: 1px solid var(--light-grey);
      text-align: left;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .rota-day-column li:last-child {
      margin-bottom: 0;
    }
    .rota-day-column li.foh, .working-staff-column li.foh { color: var(--foh-color); }
    .rota-day-column li.boh, .working-staff-column li.boh { color: var(--boh-color); }
    .rota-day-column li.admin, .working-staff-column li.admin { color: var(--admin-color); }

    /* Staff icon for "Who's working today" list */
    .working-staff-column .staff-icon {
        background: var(--secondary-bg); /* White background for list items */
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        margin-bottom: 8px;
        flex-shrink: 0; /* Prevent shrinking in flex column */
        width: 100%; /* Take full width of column */
        min-height: unset; /* Remove min-height */
        min-width: unset; /* Remove min-width */
        animation: none; /* No pulse animation in this list */
        cursor: default; /* Not clickable like on landing page */
    }
    .working-staff-column .staff-icon:hover {
        transform: none; /* No hover effect */
        box-shadow: 0 1px 4px rgba(0,0,0,0.05); /* No hover shadow */
        background: var(--secondary-bg); /* Keep background white */
        color: var(--text-color);
    }
    .working-staff-column .staff-icon .icon-placeholder {
        font-size: 2.5em; /* Slightly smaller emoji */
        margin-bottom: 5px;
    }
    .working-staff-column .staff-icon .staff-name {
        font-size: 1em;
        margin-bottom: 2px;
    }
    .working-staff-column .staff-icon .staff-role { /* This will show the shift */
        font-size: 0.8em;
        padding: 2px 6px;
        background-color: rgba(0,0,0,0.05);
        color: var(--dark-grey);
    }


    /* My Tasks View */
    #my-tasks-view .info-banner {
      font-weight: bold;
    }

    #task-list {
      list-style: none;
      padding: 0;
      flex-grow: 1;
    }

    .task-item {
      background-color: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-left: 5px solid var(--accent-color);
      padding: 12px 18px;
      margin-bottom: 10px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      transition: background-color 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      flex-wrap: wrap; /* Allow items to wrap */
    }

    .task-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    .task-item-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
    }

    .task-item input[type="checkbox"] {
      margin-right: 0px; /* Adjust margin as it's now in a flex container */
      min-width: 24px;
      min-height: 24px;
      accent-color: var(--accent-color);
      cursor: pointer;
      transform: scale(1.1);
    }
    .task-item .upload-image-btn {
        background-color: var(--dark-grey);
        color: white;
        padding: 6px 10px;
        border: none;
        border-radius: 5px;
        font-size: 0.8em;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .task-item .upload-image-btn:hover {
        background-color: #555;
    }

    .task-item .attached-image-info {
        font-size: 0.75em;
        color: var(--dark-grey);
        margin-left: 10px;
        flex-basis: 100%; /* Take full width below other items */
        text-align: right;
        margin-top: 5px; /* Space between controls and image info */
    }


    .task-item.completed {
      background-color: var(--completed-bg);
      border-color: var(--completed-border);
      border-left-color: var(--completed-border);
      text-decoration: line-through;
      color: var(--dark-grey);
      opacity: 0.8;
      box-shadow: none;
    }

    .task-item.incomplete {
      background-color: var(--incomplete-bg);
      border-color: var(--incomplete-border);
      border-left-color: var(--incomplete-border);
      animation: pulse-incomplete 1.5s infinite alternate;
    }

    @keyframes pulse-incomplete {
      from { box-shadow: 0 0 0 0 rgba(255, 140, 0, 0.3); }
      to { box-shadow: 0 0 0 8px rgba(255, 140, 0, 0); }
    }

    .task-item span {
      flex-grow: 1;
      font-size: 1.05em;
    }

    .task-item .timestamp {
      font-size: 0.85em;
      color: var(--dark-grey);
      white-space: nowrap;
      text-align: right;
    }

    .no-tasks, .no-data {
      text-align: center;
      padding: 20px;
      color: var(--dark-grey);
      font-style: italic;
      background-color: var(--light-grey);
      border-radius: 8px;
      margin-top: 15px;
    }

    /* Home View specific styles */
    #home-view #my-tasks-for-home, #home-view #message-board {
        margin-top: 20px; /* Space between sections */
    }
    #message-board .message-list {
        list-style: none;
        padding: 0;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background-color: var(--primary-bg);
    }
    .message-list li {
        padding: 8px 15px;
        border-bottom: 1px solid var(--light-grey);
        font-size: 0.9em;
    }
    .message-list li:last-child { border-bottom: none; }
    .message-list .message-sender { font-weight: bold; color: var(--accent-color); margin-right: 5px; }
    .message-list .message-timestamp { font-size: 0.8em; color: var(--dark-grey); }
    #message-input-form {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        align-items: center;
    }
    #message-input-form textarea {
        flex-grow: 1;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        min-height: 60px;
        resize: vertical;
        font-family: inherit;
        font-size: 0.9em;
        background-color: var(--primary-bg);
    }
    #message-input-form button {
        padding: 10px 15px;
        font-size: 0.9em;
        border-radius: 6px;
        background-color: var(--accent-color);
        color: white;
        border: none;
        cursor: pointer;
    }
    #message-input-form button:hover {
        background-color: var(--accent-hover);
    }


    /* Calendar View */
    #calendar-view .calendar-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    #calendar-view .calendar-controls h3 {
      margin: 0;
      font-size: 1.4em;
      color: var(--accent-color);
    }
    #calendar-view .calendar-controls button {
      background-color: var(--dark-grey);
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      transition: background-color 0.2s ease;
    }
    #calendar-view .calendar-controls button:hover {
      background-color: #555;
      transform: translateY(-1px);
    }
    #calendar-view .calendar-controls select {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      font-size: 0.9em;
      background-color: var(--primary-bg);
      color: var(--text-color);
    }
    #calendar-view .calendar-controls select:disabled {
        background-color: #f0f0f0;
        cursor: not-allowed;
    }


    #calendar-view .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 15px;
    }

    .calendar-grid .day-name {
      font-weight: bold;
      text-align: center;
      padding: 10px 5px;
      background-color: var(--light-grey);
      border-radius: 5px;
      color: var(--dark-grey);
      font-size: 0.9em;
    }

    .calendar-day {
      background-color: var(--primary-bg);
      border: 1px solid var(--border-color);
      border-radius: 5px;
      min-height: 100px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      font-size: 0.85em;
      position: relative;
    }
    .calendar-day.current-month {
      background-color: var(--secondary-bg);
    }
    .calendar-day.today {
      border: 2px solid var(--accent-color);
      box-shadow: 0 0 0 2px rgba(106, 13, 173, 0.3);
    }

    .calendar-day .day-number {
      font-weight: bold;
      font-size: 1.1em;
      color: var(--accent-color);
      margin-bottom: 5px;
      text-align: right;
      padding-right: 5px;
    }
    .calendar-day ul {
      list-style: none;
      padding: 0;
      margin-top: 5px;
      flex-grow: 1;
      overflow-y: auto;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .calendar-day ul::-webkit-scrollbar {
      display: none;
    }
    .calendar-day li {
      padding: 3px 6px;
      margin-bottom: 3px;
      border-radius: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 0.8em;
      color: var(--dark-grey);
    }
    .calendar-day li.foh-shift {
      background-color: var(--foh-light-bg);
      color: var(--foh-color);
    }
    .calendar-day li.boh-shift {
      background-color: var(--boh-light-bg);
      color: var(--boh-color);
    }
    .calendar-day li.admin-shift {
      background-color: var(--admin-light-bg);
      color: var(--admin-color);
    }

    /* Admin View */
    #admin-view {
      background-color: var(--light-grey);
      padding: 25px;
      border-radius: 12px;
      margin-top: 20px;
      box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
      border: 1px solid var(--border-color);
    }

    .admin-section {
      background-color: var(--secondary-bg);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      margin-bottom: 25px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.05);
    }

    .admin-section form {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }

    .admin-section label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      font-size: 0.95em;
      color: var(--dark-grey);
    }

    .admin-section input[type="text"],
    .admin-section input[type="date"],
    .admin-section select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.95em;
      background-color: var(--primary-bg);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .admin-section input[type="text"]:focus,
    .admin-section input[type="date"]:focus,
    .admin-section select:focus {
      outline: none;
      border-color: var(--accent-hover);
      box-shadow: 0 0 0 3px rgba(106, 13, 173, 0.2);
    }
    /* Disabled inputs in admin section for non-admins */
    .admin-section input[type="text"]:disabled,
    .admin-section input[type="date"]:disabled,
    .admin-section select:disabled,
    .admin-section button:disabled {
        background-color: #f0f0f0;
        cursor: not-allowed;
        box-shadow: none;
        border-color: #ccc;
        opacity: 0.7;
    }
    /* Ensure delete buttons are also disabled if not admin */
    .admin-section .delete-btn[disabled] {
        background-color: #cccccc;
        cursor: not-allowed;
        opacity: 0.7;
        transform: none;
        box-shadow: none;
    }


    .admin-section button {
      background-color: var(--accent-color);
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.05em;
      transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
      width: fit-content;
      margin-top: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    }

    .admin-section button:hover {
      background-color: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .admin-section button:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Admin Assigned Items Lists & Task Overview */
    #admin-assigned-tasks, #admin-assigned-shifts, #admin-attendance-list, #admin-task-overview-list {
      list-style: none;
      padding: 0;
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background-color: var(--primary-bg);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }

    #admin-assigned-tasks li, #admin-assigned-shifts li, #admin-attendance-list li, #admin-task-overview-list li {
      padding: 10px 15px;
      border-bottom: 1px solid var(--light-grey);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95em;
      transition: background-color 0.2s ease;
    }

    #admin-assigned-tasks li:last-child, #admin-assigned-shifts li:last-child, #admin-attendance-list li:last-child, #admin-task-overview-list li:last-child {
      border-bottom: none;
    }
    #admin-assigned-tasks li:hover, #admin-assigned-shifts li:hover, #admin-attendance-list li:hover, #admin-task-overview-list li:hover {
      background-color: #f0f0f0;
    }

    #admin-assigned-tasks li span, #admin-assigned-shifts li span, #admin-attendance-list li span, #admin-task-overview-list li span {
      flex-grow: 1;
    }

    .delete-btn {
      background-color: var(--delete-btn-bg);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.85em;
      transition: background-color 0.2s ease, transform 0.1s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-left: 10px;
    }

    .delete-btn:hover {
      background-color: var(--delete-btn-hover);
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    }
    .delete-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Specific styles for Task Overview list items */
    .admin-task-overview-item.completed {
        background-color: var(--completed-bg);
        color: var(--boh-color);
        border-left: 4px solid var(--completed-border);
    }
    .admin-task-overview-item.pending {
        background-color: var(--secondary-bg);
        color: var(--dark-grey);
        border-left: 4px solid var(--dark-grey);
    }
    .admin-task-overview-item.overdue {
        background-color: var(--incomplete-bg);
        color: var(--incomplete-border);
        border-left: 4px solid var(--incomplete-border);
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 15px;
      font-size: 0.8em;
      color: var(--dark-grey);
      border-top: 1px solid var(--border-color);
      background-color: var(--light-grey);
      margin-top: auto;
      border-radius: 0 0 12px 12px;
    }

    /* Media Queries for larger screens (Tablet and Desktop) */
    @media (min-width: 768px) {
      header {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
      }

      header .top-controls {
        width: auto;
        justify-content: flex-end;
        order: 2;
      }

      header h1 {
        margin-bottom: 0;
        order: 1;
      }

      header .nav-buttons {
        width: auto;
        order: 3;
        margin-top: 10px;
        flex-grow: 1;
        justify-content: center;
      }
      #weekly-rota-view .rota-grid {
        grid-template-columns: repeat(7, 1fr);
        min-width: unset;
      }

      .admin-section form {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        align-items: end;
      }

      .admin-section form button {
        grid-column: span 1;
        width: auto;
      }
    }

    @media (min-width: 1024px) {
      header .nav-buttons {
        margin-top: 0;
        order: 2;
      }
      header .top-controls {
        order: 3;
      }
      header h1 {
        order: 1;
      }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

  <!-- Landing Screen -->
  <div x-show="!user" x-transition class="min-h-screen flex flex-col items-center justify-center px-4" id="landing-page">
    <h1 class="text-3xl font-bold text-purple-600 mb-4">Welcome, Staff!</h1>
    <p class="mb-6 text-gray-600">Select your profile to continue:</p>
    <div id="staff-icons-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6">
      <template x-for="member in staff" :key="member.name">
        <button
          @click="login(member)"
          class="staff-icon" :class="member.role.toLowerCase()"
        >
          <div class="icon-placeholder" x-text="member.icon"></div>
          <div class="staff-name" x-text="member.name"></div>
          <div class="staff-role" x-text="member.role"></div>
        </button>
      </template>
    </div>
  </div>

  <!-- App Container -->
  <div x-show="user" x-transition class="min-h-screen flex flex-col" id="app-container">

    <!-- Header -->
    <header class="bg-gray-900 shadow p-4 flex flex-col items-start justify-between sm:flex-row sm:items-center">
      <div class="flex items-center space-x-4 mb-3 sm:mb-0">
        <h2 class="text-xl font-bold text-purple-400">Staff Rota & Tasks</h2>
        <span class="px-3 py-1 bg-purple-700 text-white rounded-full text-sm" x-text="user.name + ' (' + user.role + ')'"></span>
      </div>
      <div class="flex items-center space-x-2">
        <template x-if="user.role === 'Admin'">
          <button
            @click="toggleAdminMode()"
            :class="isAdminMode ? 'bg-purple-600 hover:bg-purple-700' : 'bg-purple-500 hover:bg-purple-600'"
            class="px-4 py-2 text-white rounded transition"
            x-text="isAdminMode ? 'Exit Admin' : 'Admin Mode'"
          ></button>
        </template>
        <button
          @click="logout()"
          class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition"
        >Sign Out</button>
      </div>
    </header>

    <!-- Nav -->
    <nav class="bg-gray-800 p-2 flex space-x-2 overflow-x-auto justify-center">
      <button
        @click="view='home'"
        :class="view==='home' ? 'bg-purple-600 text-white' : 'text-gray-300 hover:bg-gray-700'"
        class="px-4 py-2 rounded transition whitespace-nowrap"
      >Home</button>
      <button
        @click="view='tasks'"
        :class="view==='tasks' ? 'bg-purple-600 text-white' : 'text-gray-300 hover:bg-gray-700'"
        class="px-4 py-2 rounded transition whitespace-nowrap"
      >My Tasks</button>
      <button
        @click="view='rota'"
        :class="view==='rota' ? 'bg-purple-600 text-white' : 'text-gray-300 hover:bg-gray-700'"
        class="px-4 py-2 rounded transition whitespace-nowrap"
      >Weekly Rota</button>
      <button
        @click="view='calendar'"
        :class="view==='calendar' ? 'bg-purple-600 text-white' : 'text-gray-300 hover:bg-gray-700'"
        class="px-4 py-2 rounded transition whitespace-nowrap"
      >Calendar</button>
      <template x-if="user.role==='Admin'">
        <button
          @click="view='admin'"
          :class="view==='admin' ? 'bg-purple-600 text-white' : 'text-gray-300 hover:bg-gray-700'"
          class="px-4 py-2 rounded transition whitespace-nowrap"
        >Admin</button>
      </template>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto p-6 space-y-6">

      <!-- Home View -->
      <section x-show="view==='home'" x-transition class="home-view active">
        <div class="bg-white rounded-lg shadow p-4 flex flex-col md:flex-row items-center justify-between"
             :class="{'bg-green-100 border-green-400': isClockedIn, 'bg-red-100 border-red-400': !isClockedIn}">
          <span class="text-gray-700 font-semibold mb-2 md:mb-0" x-text="clockStatusMessage">Loading clock status...</span>
          <button @click="toggleClockStatus()" class="px-4 py-2 rounded transition"
                  :class="isClockedIn ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-green-500 hover:bg-green-600 text-white'">
            <span x-text="clockButtonText">Toggle Clock</span>
          </button>
        </div>

        <h2 class="text-2xl font-semibold mb-4 text-purple-600">Who's Working Today?</h2>
        <div class="who-is-working-grid">
            <div class="working-staff-column">
                <strong class="text-purple-600">FOH</strong>
                <template x-if="workingStaff.foh.length > 0">
                    <template x-for="member in workingStaff.foh" :key="member.name">
                        <div class="staff-icon bg-white shadow p-2 mb-2" :class="member.role.toLowerCase()">
                            <div class="icon-placeholder text-3xl" x-text="member.icon"></div>
                            <div class="staff-name text-sm" x-text="member.name"></div>
                            <div class="staff-role text-xs text-gray-500" x-text="member.shift"></div>
                        </div>
                    </template>
                </template>
                <template x-if="workingStaff.foh.length === 0">
                    <p class="text-sm text-gray-500 italic p-2">No FOH staff working.</p>
                </template>
            </div>
            <div class="working-staff-column">
                <strong class="text-purple-600">BOH</strong>
                <template x-if="workingStaff.boh.length > 0">
                    <template x-for="member in workingStaff.boh" :key="member.name">
                        <div class="staff-icon bg-white shadow p-2 mb-2" :class="member.role.toLowerCase()">
                            <div class="icon-placeholder text-3xl" x-text="member.icon"></div>
                            <div class="staff-name text-sm" x-text="member.name"></div>
                            <div class="staff-role text-xs text-gray-500" x-text="member.shift"></div>
                        </div>
                    </template>
                </template>
                <template x-if="workingStaff.boh.length === 0">
                    <p class="text-sm text-gray-500 italic p-2">No BOH staff working.</p>
                </template>
            </div>
            <div class="working-staff-column">
                <strong class="text-purple-600">Admin</strong>
                <template x-if="workingStaff.admin.length > 0">
                    <template x-for="member in workingStaff.admin" :key="member.name">
                        <div class="staff-icon bg-white shadow p-2 mb-2" :class="member.role.toLowerCase()">
                            <div class="icon-placeholder text-3xl" x-text="member.icon"></div>
                            <div class="staff-name text-sm" x-text="member.name"></div>
                            <div class="staff-role text-xs text-gray-500" x-text="member.shift"></div>
                        </div>
                    </template>
                </template>
                <template x-if="workingStaff.admin.length === 0">
                    <p class="text-sm text-gray-500 italic p-2">No Admin staff working.</p>
                </template>
            </div>
        </div>

        <h2 class="text-2xl font-semibold mb-4 text-purple-600">Your Tasks for Today</h2>
        <div class="bg-white rounded-lg shadow p-4">
            <template x-if="homeTasks.length > 0">
                <ul class="list-none p-0">
                    <template x-for="task in homeTasks" :key="task.name">
                        <li class="p-2 border-b last:border-b-0" :class="task.status === 'completed' ? 'text-gray-500 line-through' : 'text-gray-800'">
                            <span x-text="task.name"></span> (<span x-text="task.status"></span>)
                        </li>
                    </template>
                </ul>
            </template>
            <template x-if="homeTasks.length === 0">
                <p class="text-gray-500 italic">No tasks assigned for you today.</p>
            </template>
        </div>

        <h2 class="text-2xl font-semibold mb-4 text-purple-600 mt-6">Message Board</h2>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="message-list-container">
                <ul class="message-list mb-4">
                    <template x-for="message in messageBoard" :key="message.timestamp">
                        <li class="p-2 border-b last:border-b-0">
                            <span class="message-sender" x-text="message.sender + ':'"></span>
                            <span class="message-text" x-text="message.text"></span>
                            <span class="message-timestamp ml-2" x-text="'(' + new Date(message.timestamp).toLocaleString() + ')'"></span>
                        </li>
                    </template>
                    <template x-if="messageBoard.length === 0">
                        <li class="text-gray-500 italic p-2">No messages yet.</li>
                    </template>
                </ul>
                <form @submit.prevent="sendMessage()" class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <textarea x-model="newMessageText" placeholder="Write a message..." rows="3" class="flex-1 p-2 border rounded resize-y"></textarea>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition">Send</button>
                </form>
            </div>
        </div>
      </section>

      <!-- My Tasks -->
      <section x-show="view==='tasks'" x-transition class="my-tasks-view">
        <h3 class="text-2xl font-semibold mb-4 text-purple-600">My Tasks for <span x-text="currentDayInfo"></span></h3>
        <div class="bg-white rounded-lg shadow p-4">
            <template x-if="myTasks.length > 0">
                <ul class="list-none p-0">
                    <template x-for="task in myTasks" :key="task.name">
                        <li class="task-item" :class="{'completed': task.status === 'completed', 'incomplete': task.status === 'incomplete'}">
                            <span x-text="task.name" class="flex-grow"></span>
                            <div class="task-item-controls flex items-center space-x-2">
                                <input type="checkbox" class="form-checkbox h-5 w-5 text-purple-600"
                                    :checked="task.status === 'completed'"
                                    @change="toggleTaskCompletion(task.name, $event.target.checked)">
                                <button type="button" class="upload-image-btn"
                                    @click="$refs['fileInput_' + task.name].click()"
                                    x-show="task.status !== 'completed'">
                                    Attach Image
                                </button>
                                <input type="file" :ref="'fileInput_' + task.name" accept="image/*" class="hidden"
                                    @change="attachImageToTask(task.name, $event.target.files[0])">
                            </div>
                            <span class="timestamp text-gray-500 text-sm" x-text="task.timestampDisplay"></span>
                            <template x-if="task.imageName">
                                <span class="attached-image-info text-right w-full" x-text="'Image: ' + task.imageName + ' attached.'"></span>
                            </template>
                        </li>
                    </template>
                </ul>
            </template>
            <template x-if="myTasks.length === 0">
                <p class="text-gray-500 italic p-2">No tasks assigned for you today.</p>
            </template>
        </div>
      </section>

      <!-- Weekly Rota -->
      <section x-show="view==='rota'" x-transition class="weekly-rota-view">
        <h3 class="text-2xl font-semibold mb-4 text-purple-600">Weekly Rota</h3>
        <div class="bg-white rounded-lg shadow p-4 overflow-x-auto rota-grid-container">
          <div class="rota-grid">
            <template x-for="day in weeklyRota" :key="day.date">
                <div class="rota-day-column bg-gray-100 rounded-lg p-3 text-center shadow-sm">
                    <strong class="block mb-2 text-purple-600" x-text="day.displayDate"></strong>
                    <ul class="list-none p-0 w-full">
                        <template x-for="staffShift in day.shifts" :key="staffShift.name">
                            <li class="bg-white p-2 mb-1 rounded text-sm text-left shadow-sm" :class="staffShift.role.toLowerCase()"
                                x-text="staffShift.name + ': ' + staffShift.shift"></li>
                        </template>
                    </ul>
                </div>
            </template>
          </div>
        </div>
      </section>

      <!-- Calendar View -->
      <section x-show="view==='calendar'" x-transition class="calendar-view">
        <h3 class="text-2xl font-semibold mb-4 text-purple-600">Monthly Calendar</h3>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-4 calendar-controls">
                <button @click="goToPrevMonth()" class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 transition">&larr; Prev</button>
                <h4 class="text-lg font-semibold text-purple-600" x-text="currentCalendarMonthYear"></h4>
                <button @click="goToNextMonth()" class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 transition">Next &rarr;</button>
                <select x-model="calendarRoleFilter" @change="renderCalendar()"
                        class="p-2 border rounded text-sm"
                        :disabled="!isCurrentUserAdmin()">
                    <option value="all">All Staff</option>
                    <option value="FOH" :disabled="user.role !== 'Admin' && user.role !== 'FOH'">Front of House</option>
                    <option value="BOH" :disabled="user.role !== 'Admin' && user.role !== 'BOH'">Back of House</option>
                    <option value="Admin" :disabled="user.role !== 'Admin'">Admin</option>
                </select>
            </div>
            <div class="grid grid-cols-7 gap-2 text-center calendar-grid">
                <div class="font-semibold text-gray-600 text-sm">Mon</div>
                <div class="font-semibold text-gray-600 text-sm">Tue</div>
                <div class="font-semibold text-gray-600 text-sm">Wed</div>
                <div class="font-semibold text-gray-600 text-sm">Thu</div>
                <div class="font-semibold text-gray-600 text-sm">Fri</div>
                <div class="font-semibold text-gray-600 text-sm">Sat</div>
                <div class="font-semibold text-gray-600 text-sm">Sun</div>
                <template x-for="day in calendarDays" :key="day.date">
                    <div class="border p-2 rounded text-sm h-28 overflow-hidden relative"
                         :class="{'bg-gray-50': !day.currentMonth, 'bg-white': day.currentMonth, 'border-purple-500 border-2': day.isToday, 'text-gray-400': !day.currentMonth}">
                        <div class="font-bold text-right" :class="{'text-purple-600': day.currentMonth && !day.isToday, 'text-purple-800': day.isToday}" x-text="day.dayNumber"></div>
                        <ul class="list-none p-0 mt-1 space-y-0.5 max-h-16 overflow-y-auto">
                            <template x-for="shift in day.shifts" :key="shift.name + shift.type">
                                <li class="px-1 py-0.5 rounded text-xs truncate"
                                    :class="{'bg-blue-100 text-blue-700': shift.role === 'FOH', 'bg-green-100 text-green-700': shift.role === 'BOH', 'bg-gray-100 text-gray-700': shift.role === 'Admin'}"
                                    x-text="shift.name + ': ' + shift.type"></li>
                            </template>
                        </ul>
                    </div>
                </template>
            </div>
        </div>
      </section>

      <!-- Admin Panel -->
      <section x-show="view==='admin'" x-transition class="admin-view">
        <h3 class="text-2xl font-semibold mb-4 text-purple-600">Admin Panel</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <!-- Assign Shifts -->
            <div class="bg-white rounded-lg shadow p-4">
                <h4 class="font-semibold mb-3">Assign Shifts</h4>
                <form @submit.prevent="assignShift()" class="space-y-3">
                    <div>
                        <label for="shift-user-select" class="block text-sm font-medium text-gray-700">Staff Member:</label>
                        <select x-model="shiftForm.staffName" id="shift-user-select" required
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm rounded-md"
                                :disabled="!isCurrentUserAdmin()">
                            <template x-for="member in staff" :key="member.name">
                                <option :value="member.name" x-text="member.name + ' (' + member.role + ')'"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label for="shift-date" class="block text-sm font-medium text-gray-700">Date:</label>
                        <input type="date" x-model="shiftForm.date" id="shift-date" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                               :disabled="!isCurrentUserAdmin()">
                    </div>
                    <div>
                        <label for="shift-type-select" class="block text-sm font-medium text-gray-700">Shift Type:</label>
                        <select x-model="shiftForm.type" @change="handleShiftTypeChange()" id="shift-type-select" required
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm rounded-md"
                                :disabled="!isCurrentUserAdmin()">
                            <option value="">Select Shift</option>
                            <option value="8AM-4PM">8AM-4PM</option>
                            <option value="12PM-8PM">12PM-8PM</option>
                            <option value="5PM-Close">5PM-Close</option>
                            <option value="Off">Off</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div x-show="shiftForm.type === 'custom'" class="transition-all duration-300" id="custom-shift-input-container">
                        <label for="custom-shift-type" class="block text-sm font-medium text-gray-700">Custom Shift:</label>
                        <input type="text" x-model="shiftForm.customType" id="custom-shift-type" placeholder="e.g., 9AM-5PM"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                               :required="shiftForm.type === 'custom'"
                               :disabled="!isCurrentUserAdmin()">
                    </div>
                    <div>
                        <label for="shift-repeat-days" class="block text-sm font-medium text-gray-700">Repeat for (days):</label>
                        <input type="number" x-model.number="shiftForm.repeatDays" id="shift-repeat-days" min="1" max="7" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                               :disabled="!isCurrentUserAdmin()">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition"
                            :disabled="!isCurrentUserAdmin()">Assign Shift</button>
                </form>
            </div>

            <!-- Assigned Shifts View -->
            <div class="bg-white rounded-lg shadow p-4">
                <h4 class="font-semibold mb-3">Assigned Shifts</h4>
                <div class="flex space-x-2 mb-3">
                    <select x-model="assignedShiftsView.staffName" @change="renderAdminAssignedShifts()"
                            class="flex-1 p-2 border rounded text-sm"
                            :disabled="!isCurrentUserAdmin()">
                        <template x-for="member in staff" :key="member.name">
                            <option :value="member.name" x-text="member.name + ' (' + member.role + ')'"></option>
                        </template>
                    </select>
                    <input type="date" x-model="assignedShiftsView.date" @change="renderAdminAssignedShifts()"
                           class="p-2 border rounded text-sm"
                           :disabled="!isCurrentUserAdmin()">
                </div>
                <ul class="space-y-2 max-h-60 overflow-y-auto border rounded p-2 bg-gray-50">
                    <template x-if="assignedShifts.length > 0">
                        <template x-for="shift in assignedShifts" :key="shift.name + shift.date">
                            <li class="flex justify-between items-center bg-white p-2 rounded shadow-sm">
                                <span x-text="shift.name + ': ' + shift.type + ' on ' + shift.date"></span>
                                <button @click="deleteAdminItem('shift', shift.name, shift.date)"
                                        class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 transition"
                                        :disabled="!isCurrentUserAdmin()">Delete</button>
                            </li>
                        </template>
                    </template>
                    <template x-if="assignedShifts.length === 0">
                        <li class="text-gray-500 italic text-center p-4">No shifts found.</li>
                    </template>
                </ul>
            </div>

            <!-- Assign Tasks -->
            <div class="bg-white rounded-lg shadow p-4">
                <h4 class="font-semibold mb-3">Assign Daily Tasks</h4>
                <form @submit.prevent="assignTask()" class="space-y-3">
                    <div>
                        <label for="task-user-select" class="block text-sm font-medium text-gray-700">Staff Member:</label>
                        <select x-model="taskForm.staffName" id="task-user-select" required
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm rounded-md"
                                :disabled="!isCurrentUserAdmin()">
                            <template x-for="member in staff" :key="member.name">
                                <option :value="member.name" x-text="member.name + ' (' + member.role + ')'"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label for="task-date" class="block text-sm font-medium text-gray-700">Date:</label>
                        <input type="date" x-model="taskForm.date" id="task-date" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                               :disabled="!isCurrentUserAdmin()">
                    </div>
                    <div>
                        <label for="task-description-select" class="block text-sm font-medium text-gray-700">Task Description:</label>
                        <select x-model="taskForm.description" @change="handleTaskDescriptionChange()" id="task-description-select" required
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm rounded-md"
                                :disabled="!isCurrentUserAdmin()">
                            <option value="">Select Task</option>
                            <option value="Slicing Lemons">Slicing Lemons</option>
                            <option value="Rolling Silverware">Rolling Silverware</option>
                            <option value="Polishing Glasses">Polishing Glasses</option>
                            <option value="Cleaning Beer Lines">Cleaning Beer Lines</option>
                            <option value="Cleaning Fridge Seals">Cleaning Fridge Seals</option>
                            <option value="Cleaning Glasswash">Cleaning Glasswash</option>
                            <option value="Custom Task">Custom Task</option>
                        </select>
                    </div>
                    <div x-show="taskForm.description === 'Custom Task'" class="transition-all duration-300" id="custom-task-input-container">
                        <label for="custom-task-description" class="block text-sm font-medium text-gray-700">Custom Task:</label>
                        <input type="text" x-model="taskForm.customDescription" id="custom-task-description" placeholder="e.g., Organize storage room"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                               :required="taskForm.description === 'Custom Task'"
                               :disabled="!isCurrentUserAdmin()">
                    </div>
                    <div>
                        <label for="task-repeat-days" class="block text-sm font-medium text-gray-700">Repeat for (days):</label>
                        <input type="number" x-model.number="taskForm.repeatDays" id="task-repeat-days" min="1" max="7" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                               :disabled="!isCurrentUserAdmin()">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition"
                            :disabled="!isCurrentUserAdmin()">Add Task</button>
                </form>
            </div>

            <!-- Assigned Tasks View -->
            <div class="bg-white rounded-lg shadow p-4">
                <h4 class="font-semibold mb-3">Assigned Tasks</h4>
                <div class="flex space-x-2 mb-3">
                    <select x-model="assignedTasksView.staffName" @change="renderAdminAssignedTasks()"
                            class="flex-1 p-2 border rounded text-sm"
                            :disabled="!isCurrentUserAdmin()">
                        <template x-for="member in staff" :key="member.name">
                            <option :value="member.name" x-text="member.name + ' (' + member.role + ')'"></option>
                        </template>
                    </select>
                    <input type="date" x-model="assignedTasksView.date" @change="renderAdminAssignedTasks()"
                           class="p-2 border rounded text-sm"
                           :disabled="!isCurrentUserAdmin()">
                </div>
                <ul class="space-y-2 max-h-60 overflow-y-auto border rounded p-2 bg-gray-50">
                    <template x-if="assignedTasks.length > 0">
                        <template x-for="task in assignedTasks" :key="task.name">
                            <li class="flex justify-between items-center bg-white p-2 rounded shadow-sm">
                                <span x-text="task.name"></span>
                                <button @click="deleteAdminItem('task', assignedTasksView.staffName, assignedTasksView.date, task.name)"
                                        class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 transition"
                                        :disabled="!isCurrentUserAdmin()">Delete</button>
                            </li>
                        </template>
                    </template>
                    <template x-if="assignedTasks.length === 0">
                        <li class="text-gray-500 italic text-center p-4">No tasks found.</li>
                    </template>
                </ul>
            </div>

            <!-- Shift Attendance -->
            <div class="bg-white rounded-lg shadow p-4">
                <h4 class="font-semibold mb-3">Shift Attendance</h4>
                <div class="mb-3">
                    <label for="attendance-date" class="block text-sm font-medium text-gray-700">Date:</label>
                    <input type="date" x-model="attendanceView.date" @change="renderAdminShiftAttendance()"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"
                           :disabled="!isCurrentUserAdmin()">
                </div>
                <ul class="space-y-2 max-h-60 overflow-y-auto border rounded p-2 bg-gray-50">
                    <template x-if="attendanceList.length > 0">
                        <template x-for="record in attendanceList" :key="record.name">
                            <li class="flex flex-col items-start bg-white p-2 rounded shadow-sm"
                                :class="{'border-l-4 border-green-500': record.status === 'Clocked In', 'border-l-4 border-red-500': record.status === 'Not Clocked In'}">
                                <span class="font-semibold" x-text="record.name"></span>
                                <span class="text-sm text-gray-600" x-text="record.statusText"></span>
                            </li>
                        </template>
                    </template>
                    <template x-if="attendanceList.length === 0">
                        <li class="text-gray-500 italic text-center p-4">No attendance records for this date.</li>
                    </template>
                </ul>
            </div>

            <!-- Task Overview -->
            <div class="bg-white rounded-lg shadow p-4">
                <h4 class="font-semibold mb-3">Task Overview</h4>
                <div class="flex space-x-2 mb-3">
                    <input type="date" x-model="taskOverviewView.date" @change="renderAdminTaskOverview()"
                           class="flex-1 p-2 border rounded text-sm"
                           :disabled="!isCurrentUserAdmin()">
                    <select x-model="taskOverviewView.statusFilter" @change="renderAdminTaskOverview()"
                            class="p-2 border rounded text-sm"
                            :disabled="!isCurrentUserAdmin()">
                        <option value="all">All</option>
                        <option value="completed">Completed</option>
                        <option value="pending">Pending</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>
                <ul class="space-y-2 max-h-60 overflow-y-auto border rounded p-2 bg-gray-50">
                    <template x-if="taskOverviewList.length > 0">
                        <template x-for="task in taskOverviewList" :key="task.staffName + task.taskName + task.status">
                            <li class="flex flex-col items-start bg-white p-2 rounded shadow-sm"
                                :class="{'border-l-4 border-green-500': task.status === 'completed', 'border-l-4 border-yellow-500': task.status === 'pending', 'border-l-4 border-red-500': task.status === 'overdue'}">
                                <span class="font-semibold" x-text="task.staffName + ': ' + task.taskName"></span>
                                <span class="text-sm text-gray-600" x-text="'Status: ' + task.statusText + (task.timestamp ? ' at ' + task.timestamp : '')"></span>
                                <template x-if="task.imageName">
                                    <span class="text-xs text-gray-500 italic" x-text="'Image: ' + task.imageName"></span>
                                </template>
                            </li>
                        </template>
                    </template>
                    <template x-if="taskOverviewList.length === 0">
                        <li class="text-gray-500 italic text-center p-4">No tasks found for this date/filter.</li>
                    </template>
                </ul>
            </div>

        </div>
      </section>

    </main>
    <footer class="bg-gray-800 text-gray-400 p-4 text-center text-sm">
      <p>&copy; <span x-text="new Date().getFullYear()"></span> Staff Rota & Tasks. All rights reserved.</p>
    </footer>
  </div>

  <script>
    function app() {
      return {
        // --- Data Properties (Reactive) ---
        staff: [],
        user: null, // Logged-in user object { name: '', role: '', icon: '' }
        view: 'home', // Current active view ('home', 'tasks', 'rota', 'calendar', 'admin', 'landing')

        // Core App Data (synced with localStorage)
        rota: {}, // { 'YYYY-MM-DD': { 'Staff Name': 'Shift Type' } }
        dailyTasks: {}, // { 'YYYY-MM-DD': { 'Staff Name': ['Task 1', 'Task 2'] } }
        completedTasks: {}, // { 'YYYY-MM-DD': { 'Staff Name': { 'Task Name': {timestamp: ts, imageName: 'file.jpg'} } } }
        clockIns: {}, // { 'YYYY-MM-DD': { 'Staff Name': { 'in': timestamp, 'out': timestamp | null } } }
        messageBoard: [], // [{ sender: 'Name', text: 'Message', timestamp: 123456789 }]

        // UI State for Forms/Views
        isAdminMode: false,
        currentCalendarDate: new Date(), // For calendar view
        calendarRoleFilter: 'all', // Filter for calendar view

        // Form data for Admin Panel
        shiftForm: {
            staffName: '',
            date: '',
            type: '',
            customType: '',
            repeatDays: 1,
        },
        taskForm: {
            staffName: '',
            date: '',
            description: '',
            customDescription: '',
            repeatDays: 1,
        },
        // Data for admin view lists
        assignedShiftsView: { staffName: '', date: '' },
        assignedShifts: [],
        assignedTasksView: { staffName: '', date: '' },
        assignedTasks: [],
        attendanceView: { date: '' },
        attendanceList: [],
        taskOverviewView: { date: '', statusFilter: 'all' },
        taskOverviewList: [],
        newMessageText: '', // For message board input


        // --- Computed Properties ---
        get todayFormatted() {
            return this.getFormattedDate(new Date());
        },
        get currentDayInfo() {
            return this.getDisplayDate(new Date());
        },
        get currentCalendarMonthYear() {
            return this.currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        },
        get isClockedIn() {
            const data = this.clockIns[this.todayFormatted]?.[this.user?.name];
            return data && data.in && !data.out;
        },
        get clockStatusMessage() {
            if (!this.user) return 'Please log in.';
            const data = this.clockIns[this.todayFormatted]?.[this.user.name];
            if (data?.in && !data.out) {
                return `You are clocked in since ${this.formatTimestampToTime(data.in)}`;
            } else if (data?.in && data.out) {
                return `Clocked in: ${this.formatTimestampToTime(data.in)}, Clocked out: ${this.formatTimestampToTime(data.out)}`;
            } else {
                return 'You are not clocked in for today.';
            }
        },
        get clockButtonText() {
            return this.isClockedIn ? 'Clock Out' : 'Clock In';
        },
        get homeTasks() {
            if (!this.user) return [];
            const tasks = this.dailyTasks[this.todayFormatted]?.[this.user.name] || [];
            const completed = this.completedTasks[this.todayFormatted]?.[this.user.name] || {};
            return tasks.map(task => ({
                name: task,
                status: completed[task] ? 'completed' : 'pending'
            }));
        },
        get myTasks() { // This is for the "My Tasks" page, more detailed
            if (!this.user) return [];
            const tasks = this.dailyTasks[this.todayFormatted]?.[this.user.name] || [];
            const completed = this.completedTasks[this.todayFormatted]?.[this.user.name] || {};

            return tasks.map(taskName => {
                const completionData = completed[taskName];
                const isCompleted = !!completionData;
                const timestamp = typeof completionData === 'object' ? completionData.timestamp : completionData;
                const imageName = typeof completionData === 'object' ? completionData.imageName : null;
                const status = isCompleted ? 'completed' : (this.isPastEndOfDay(this.todayFormatted) ? 'incomplete' : 'pending');

                return {
                    name: taskName,
                    status: status,
                    timestamp: timestamp,
                    timestampDisplay: timestamp ? this.formatTimestampToTime(timestamp) : '',
                    imageName: imageName
                };
            });
        },
        get weeklyRota() {
            const weekDays = this.getWeekDays(new Date());
            return weekDays.map(day => {
                const formattedDate = this.getFormattedDate(day);
                const dayRota = this.rota[formattedDate] || {};
                
                const shifts = this.staff.filter(member => {
                    // Apply current user's role restrictions for read-only access
                    if (this.user && this.user.role !== 'Admin') {
                        if (this.user.role === 'FOH' && member.role === 'BOH') return false;
                        if (this.user.role === 'BOH' && member.role === 'FOH') return false;
                    }
                    return true;
                }).sort((a, b) => {
                    const roleOrder = { 'FOH': 1, 'BOH': 2, 'Admin': 3 };
                    if (roleOrder[a.role] !== roleOrder[b.role]) {
                        return roleOrder[a.role] - roleOrder[b.role];
                    }
                    return a.name.localeCompare(b.name);
                }).map(member => ({
                    name: member.name,
                    role: member.role,
                    shift: dayRota[member.name] || 'Off'
                }));

                return {
                    date: formattedDate,
                    displayDate: this.getDisplayDate(day),
                    shifts: shifts
                };
            });
        },
        get calendarDays() {
            const year = this.currentCalendarDate.getFullYear();
            const month = this.currentCalendarDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const numDaysInMonth = lastDayOfMonth.getDate();
            const firstDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7; // Monday = 0

            let days = [];
            for (let i = 0; i < firstDayOfWeek; i++) {
                days.push({ date: null, dayNumber: '', currentMonth: false, isToday: false, shifts: [] });
            }

            const todayFormatted = this.getFormattedDate(new Date());

            for (let dayNum = 1; dayNum <= numDaysInMonth; dayNum++) {
                const dayDate = new Date(year, month, dayNum);
                const formattedDate = this.getFormattedDate(dayDate);
                const isToday = formattedDate === todayFormatted;
                const dayRota = this.rota[formattedDate] || {};

                const filteredShifts = this.staff.filter(member => {
                    // Apply user's role visibility and selected filter from dropdown
                    if (this.user && this.user.role !== 'Admin') {
                        if (this.user.role === 'FOH' && member.role === 'BOH') return false;
                        if (this.user.role === 'BOH' && member.role === 'FOH') return false;
                        // Admins can be seen by FOH/BOH, so no explicit filter there unless calendar filter is specific
                    }
                    
                    if (this.calendarRoleFilter === 'all') {
                        return true;
                    } else {
                        return member.role === this.calendarRoleFilter;
                    }
                }).sort((a, b) => a.name.localeCompare(b.name))
                  .map(member => ({
                    name: member.name,
                    role: member.role,
                    type: dayRota[member.name] || 'Off'
                }));

                days.push({
                    date: formattedDate,
                    dayNumber: dayNum,
                    currentMonth: true,
                    isToday: isToday,
                    shifts: filteredShifts.filter(s => s.type !== 'Off') // Only show actual shifts
                });
            }
            return days;
        },
        get workingStaff() {
            const today = new Date();
            const formattedToday = this.getFormattedDate(today);
            const todayRota = this.rota[formattedToday] || {};

            let foh = [];
            let boh = [];
            let admin = [];

            this.staff.filter(member => {
                // Apply current user's role restrictions for display on homepage
                if (this.user && this.user.role !== 'Admin') {
                    if (this.user.role === 'FOH' && member.role === 'BOH') return false;
                    if (this.user.role === 'BOH' && member.role === 'FOH') return false;
                }
                return true;
            }).forEach(member => {
                const shift = todayRota[member.name];
                if (shift && shift !== 'Off') {
                    const staffData = { name: member.name, role: member.role, icon: member.icon, shift: shift };
                    if (member.role === 'FOH') foh.push(staffData);
                    else if (member.role === 'BOH') boh.push(staffData);
                    else if (member.role === 'Admin') admin.push(staffData);
                }
            });
            return { foh, boh, admin };
        },

        // --- Initialization Logic ---
        init() {
            try {
                // Load all data from localStorage
                this.staff = this.loadData('staffMembers') || [
                    { name: 'Jill',    role: 'FOH',  icon: '💁‍♀️' },
                    { name: 'Alice',   role: 'FOH',  icon: '💁‍♀️' },
                    { name: 'Callum',  role: 'FOH',  icon: '💁‍♀️' },
                    { name: 'Jess',    role: 'FOH',  icon: '💁‍♀️' },
                    { name: 'Danny',   role: 'BOH',  icon: '👩‍🍳' },
                    { name: 'Neil',    role: 'BOH',  icon: '👩‍🍳' },
                    { name: 'Terry',   role: 'BOH',  icon: '👴' },
                    { name: 'Richard', role: 'BOH',  icon: '👩‍🍳' },
                    { name: 'Johnny',  role: 'Admin',icon: '🤵'  },
                    { name: 'Lyndsey', role: 'Admin',icon: '🤵'  },
                    { name: 'Collin',  role: 'Admin',icon: '🤵'  }
                ];
                this.rota = this.loadData('rota') || {};
                this.dailyTasks = this.loadData('dailyTasks') || {};
                this.completedTasks = this.loadData('completedTasks') || {};
                this.clockIns = this.loadData('clockIns') || {};
                this.messageBoard = this.loadData('messageBoard') || [];

                // Attempt to restore user session
                const savedUserName = this.loadData('currentUserName');
                const savedUserRole = this.loadData('currentUserRole');
                if (savedUserName && savedUserRole) {
                    this.user = this.staff.find(s => s.name === savedUserName && s.role === savedUserRole) || null;
                    // If user restored, also restore admin mode status (if they are admin)
                    if (this.user && this.user.role === 'Admin') {
                        this.isAdminMode = this.loadData('isAdminMode') || false;
                    } else {
                        this.isAdminMode = false; // Force non-admin to not be in admin mode
                    }
                } else {
                    this.user = null; // No saved user, ensure user is null
                    this.isAdminMode = false;
                }

                // Initial view setup
                if (this.user) {
                    this.view = 'home'; // Always start at home if logged in
                    this.cleanupOldData(); // Clean up data on app load
                } else {
                    this.view = 'landing'; // Show landing page
                }

                // Initialize form dates to today
                const today = this.getFormattedDate(new Date());
                this.shiftForm.date = today;
                this.taskForm.date = today;
                this.assignedShiftsView.date = today;
                this.assignedTasksView.date = today;
                this.attendanceView.date = today;
                this.taskOverviewView.date = today;

                // Initial renders for admin lists (since they depend on initial selected values)
                this.renderAdminAssignedShifts();
                this.renderAdminAssignedTasks();
                this.renderAdminShiftAttendance();
                this.renderAdminTaskOverview();

            } catch (e) {
                console.error(`Error during app initialization: ${e.message}`, e);
                alert("An error occurred during app initialization. Please check the console for details.");
            }
        },

        // --- Utility Methods (moved from global scope into app function) ---
        loadData(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.warn(`Could not load data for key "${key}" from localStorage.`, e);
                return null;
            }
        },
        saveData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(`Could not save data for key "${key}" to localStorage.`, e);
                alert("Error saving data. Local storage might be full.");
            }
        },
        getFormattedDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        },
        formatTimestampToTime(timestamp) {
            if (!timestamp) return 'N/A';
            return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        },
        getDisplayDate(date) {
            return date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        },
        addDays(date, days) {
            const newDate = new Date(date);
            newDate.setDate(date.getDate() + days);
            return newDate;
        },
        isPastEndOfDay(dateString) {
            const checkDate = new Date(dateString);
            const today = new Date();
            checkDate.setHours(23, 59, 59, 999);
            today.setHours(0, 0, 0, 0);
            return checkDate < today;
        },
        // Cleans up messages and old task completion records
        cleanupOldData() {
            const twentyFourHoursAgo = Date.now() - (24 * 60 * 60 * 1000);

            // Clean up message board
            this.messageBoard = this.messageBoard.filter(msg => msg.timestamp > twentyFourHoursAgo);
            this.saveData('messageBoard', this.messageBoard);

            // Clean up old completed task records
            let cleanedCompletedTasks = {};
            for (const dateKey in this.completedTasks) {
                if (!this.isPastEndOfDay(dateKey)) { // Keep current/future dates as-is
                    cleanedCompletedTasks[dateKey] = this.completedTasks[dateKey];
                } else { // For past dates, filter out old completed tasks
                    let tasksForDate = {};
                    for (const staffName in this.completedTasks[dateKey]) {
                        let tasksForStaff = {};
                        for (const taskName in this.completedTasks[dateKey][staffName]) {
                            const completionData = this.completedTasks[dateKey][staffName][taskName];
                            const timestamp = typeof completionData === 'object' ? completionData.timestamp : completionData;
                            if (timestamp > twentyFourHoursAgo) {
                                tasksForStaff[taskName] = completionData;
                            }
                        }
                        if (Object.keys(tasksForStaff).length > 0) {
                            tasksForDate[staffName] = tasksForStaff;
                        }
                    }
                    if (Object.keys(tasksForDate).length > 0) {
                        cleanedCompletedTasks[dateKey] = tasksForDate;
                    }
                }
            }
            this.completedTasks = cleanedCompletedTasks;
            this.saveData('completedTasks', this.completedTasks);
        },

        // --- Authentication Methods ---
        login(member) {
            this.user = member;
            this.saveData('currentUserName', member.name);
            this.saveData('currentUserRole', member.role);
            this.isAdminMode = false; // Always reset admin mode on new login
            this.saveData('isAdminMode', false);
            this.view = 'home'; // Always navigate to home after login
            this.cleanupOldData(); // Clean up data after login
        },
        logout() {
            this.user = null;
            this.isAdminMode = false; // Ensure admin mode is off
            this.saveData('currentUserName', null);
            this.saveData('currentUserRole', null);
            this.saveData('isAdminMode', false);
            this.view = 'landing'; // Navigate to landing page
        },
        toggleAdminMode() {
            if (!this.user || this.user.role !== 'Admin') {
                alert('You do not have permission to access Admin Mode.');
                return;
            }
            this.isAdminMode = !this.isAdminMode;
            this.saveData('isAdminMode', this.isAdminMode);
            this.view = this.isAdminMode ? 'admin' : 'home'; // Go to admin or back to home
        },

        // --- Home View Specific Methods ---
        renderHomePage() {
            // Re-render clock status and message board, who's working
            this.isClockedIn; // Re-evaluate computed property
            this.clockStatusMessage; // Re-evaluate computed property
            this.clockButtonText; // Re-evaluate computed property
            this.workingStaff; // Re-evaluate computed property
            this.homeTasks; // Re-evaluate computed property
            this.cleanupOldData(); // Ensure cleanup runs when home is viewed
        },
        toggleClockStatus() {
            const now = Date.now();
            const userData = this.clockIns[this.todayFormatted] = this.clockIns[this.todayFormatted] || {};
            userData[this.user.name] = userData[this.user.name] || {};

            const userClockRecord = userData[this.user.name];

            if (!userClockRecord.in) {
                userClockRecord.in = now;
                userClockRecord.out = null;
                alert(`${this.user.name} clocked in at ${this.formatTimestampToTime(now)}.`);
            } else if (userClockRecord.in && !userClockRecord.out) {
                userClockRecord.out = now;
                alert(`${this.user.name} clocked out at ${this.formatTimestampToTime(now)}.`);
            } else { // User was clocked out, clock them back in for a new shift
                userClockRecord.in = now;
                userClockRecord.out = null;
                alert(`${this.user.name} re-clocked in at ${this.formatTimestampToTime(now)}.`);
            }
            this.saveData('clockIns', this.clockIns);
            // Alpine reactivity will update computed properties automatically
            this.renderHomePage(); // Force full re-render of homepage for consistency
        },
        sendMessage() {
            if (this.newMessageText.trim() === '') {
                alert('Message cannot be empty.');
                return;
            }
            if (!this.user) {
                alert('Please log in to send a message.');
                return;
            }

            this.messageBoard.push({
                sender: this.user.name,
                text: this.newMessageText,
                timestamp: Date.now()
            });
            this.saveData('messageBoard', this.messageBoard);
            this.newMessageText = ''; // Clear input
            this.renderHomePage(); // Re-render message board (computed property will update)
        },

        // --- My Tasks View Specific Methods ---
        toggleTaskCompletion(taskName, isChecked) {
            const taskDate = this.todayFormatted; // Always current day for My Tasks
            const staffName = this.user.name;

            this.completedTasks[taskDate] = this.completedTasks[taskDate] || {};
            this.completedTasks[taskDate][staffName] = this.completedTasks[taskDate][staffName] || {};

            const existingCompletionData = this.completedTasks[taskDate][staffName][taskName];
            const currentImageName = (typeof existingCompletionData === 'object' && existingCompletionData !== null) ? existingCompletionData.imageName : null;

            if (isChecked) {
                this.completedTasks[taskDate][staffName][taskName] = {
                    timestamp: Date.now(),
                    imageName: currentImageName // Preserve existing image info
                };
            } else {
                delete this.completedTasks[taskDate][staffName][taskName];
                if (Object.keys(this.completedTasks[taskDate][staffName]).length === 0) {
                    delete this.completedTasks[taskDate][staffName];
                }
            }
            this.saveData('completedTasks', this.completedTasks);
            // Alpine reactivity will update `myTasks` computed property
            this.renderHomePage(); // Update home view
            if (this.isAdminMode) this.renderAdminTaskOverview(); // Update admin view if open
        },
        attachImageToTask(taskName, file) {
            if (!file) return;
            const taskDate = this.todayFormatted;
            const staffName = this.user.name;

            this.completedTasks[taskDate] = this.completedTasks[taskDate] || {};
            this.completedTasks[taskDate][staffName] = this.completedTasks[taskDate][staffName] || {};

            const currentCompletion = this.completedTasks[taskDate][staffName][taskName];
            const existingTimestamp = (typeof currentCompletion === 'object' && currentCompletion !== null) ? currentCompletion.timestamp : currentCompletion;

            // Store only the file name
            this.completedTasks[taskDate][staffName][taskName] = {
                timestamp: existingTimestamp || Date.now(),
                imageName: file.name
            };

            this.saveData('completedTasks', this.completedTasks);
            alert(`Image "${file.name}" attached to "${taskName}". (Note: Image data is NOT stored in this demo.)`);
            // Alpine reactivity will update `myTasks` computed property
            this.renderHomePage(); // Update home view
            if (this.isAdminMode) this.renderAdminTaskOverview(); // Update admin view if open
        },

        // --- Rota View Specific Methods ---
        renderWeeklyRota() {
            // Computed property `weeklyRota` handles rendering
            // No explicit action needed here beyond data updates triggering reactivity
        },

        // --- Calendar View Specific Methods ---
        renderCalendar() {
            // Computed property `calendarDays` handles rendering
            // No explicit action needed here beyond data updates triggering reactivity
        },
        goToPrevMonth() {
            this.currentCalendarDate = new Date(this.currentCalendarDate.setMonth(this.currentCalendarDate.getMonth() - 1));
            // Reactivity handles re-render
        },
        goToNextMonth() {
            this.currentCalendarDate = new Date(this.currentCalendarDate.setMonth(this.currentCalendarDate.getMonth() + 1));
            // Reactivity handles re-render
        },

        // --- Admin View Specific Methods ---
        renderAdminForms() {
            // Set initial selected values for dropdowns when admin panel is rendered
            this.shiftForm.staffName = this.user ? this.user.name : (this.staff[0]?.name || '');
            this.taskForm.staffName = this.user ? this.user.name : (this.staff[0]?.name || '');
            this.assignedShiftsView.staffName = this.user ? this.user.name : (this.staff[0]?.name || '');
            this.assignedTasksView.staffName = this.user ? this.user.name : (this.staff[0]?.name || '');
            this.attendanceView.date = this.todayFormatted;
            this.taskOverviewView.date = this.todayFormatted;

            // Call render methods for lists that depend on these selections
            this.renderAdminAssignedShifts();
            this.renderAdminAssignedTasks();
            this.renderAdminShiftAttendance();
            this.renderAdminTaskOverview();

            // Handle custom input visibility for initial state
            this.handleShiftTypeChange();
            this.handleTaskDescriptionChange();
        },
        handleShiftTypeChange() {
            if (this.shiftForm.type === 'custom') {
                // Ensure custom input is shown only for admins
                document.getElementById('custom-shift-input-container').style.display = this.isCurrentUserAdmin() ? 'block' : 'none';
            } else {
                document.getElementById('custom-shift-input-container').style.display = 'none';
                this.shiftForm.customType = '';
            }
        },
        handleTaskDescriptionChange() {
            if (this.taskForm.description === 'Custom Task') {
                // Ensure custom input is shown only for admins
                document.getElementById('custom-task-input-container').style.display = this.isCurrentUserAdmin() ? 'block' : 'none';
            } else {
                document.getElementById('custom-task-input-container').style.display = 'none';
                this.taskForm.customDescription = '';
            }
        },
        assignShift() {
            if (!this.isCurrentUserAdmin()) { alert('Permission denied.'); return; }

            const staff = this.shiftForm.staffName;
            const baseDate = new Date(this.shiftForm.date);
            const repeatDays = this.shiftForm.repeatDays;
            let shiftType = this.shiftForm.type;

            if (shiftType === 'custom') {
                shiftType = this.shiftForm.customType.trim();
                if (!shiftType) { alert('Please enter a custom shift type.'); return; }
            }
            if (!staff || !baseDate || !shiftType || !repeatDays) { alert('Please fill all shift assignment fields.'); return; }
            if (shiftType.length < 2 || shiftType.length > 20) { alert('Shift type should be between 2 and 20 characters.'); return; }
            if (isNaN(repeatDays) || repeatDays < 1 || repeatDays > 7) { alert('Repeat days must be between 1 and 7.'); return; }

            let assignmentsMade = 0;
            for (let i = 0; i < repeatDays; i++) {
                const currentDate = this.addDays(baseDate, i);
                const formattedDate = this.getFormattedDate(currentDate);

                this.rota[formattedDate] = this.rota[formattedDate] || {};
                this.rota[formattedDate][staff] = shiftType;
                assignmentsMade++;
            }
            this.saveData('rota', this.rota);
            alert(`Shift '${shiftType}' assigned to ${staff} for ${assignmentsMade} day(s).`);

            // Reset form and update views
            this.shiftForm.type = '8AM-4PM'; // Reset select
            this.shiftForm.customType = ''; // Clear custom input
            this.shiftForm.repeatDays = 1; // Reset repeat days
            document.getElementById('custom-shift-input-container').style.display = 'none';

            this.renderWeeklyRota();
            this.renderCalendar();
            this.renderAdminAssignedShifts();
            this.renderHomePage(); // Update home page for "Who's working"
        },
        assignTask() {
            if (!this.isCurrentUserAdmin()) { alert('Permission denied.'); return; }

            const staff = this.taskForm.staffName;
            const baseDate = new Date(this.taskForm.date);
            const repeatDays = this.taskForm.repeatDays;
            let taskDescription = this.taskForm.description;

            if (taskDescription === 'Custom Task') {
                taskDescription = this.taskForm.customDescription.trim();
                if (!taskDescription) { alert('Please enter a custom task description.'); return; }
            }

            if (!staff || !baseDate || !taskDescription || !repeatDays) { alert('Please fill all task assignment fields.'); return; }
            if (taskDescription.length < 3 || taskDescription.length > 100) { alert('Task description should be between 3 and 100 characters.'); return; }
            if (isNaN(repeatDays) || repeatDays < 1 || repeatDays > 7) { alert('Repeat days must be between 1 and 7.'); return; }

            let assignmentsMade = 0;
            for (let i = 0; i < repeatDays; i++) {
                const currentDate = this.addDays(baseDate, i);
                const formattedDate = this.getFormattedDate(currentDate);

                this.dailyTasks[formattedDate] = this.dailyTasks[formattedDate] || {};
                this.dailyTasks[formattedDate][staff] = this.dailyTasks[formattedDate][staff] || [];

                if (!this.dailyTasks[formattedDate][staff].includes(taskDescription)) {
                    this.dailyTasks[formattedDate][staff].push(taskDescription);
                    assignmentsMade++;
                }
            }

            if (assignmentsMade > 0) {
                this.saveData('dailyTasks', this.dailyTasks);
                alert(`Task '${taskDescription}' added for ${staff} for ${assignmentsMade} day(s).`);
            } else {
                alert('No new tasks were added (they might already exist).');
            }

            // Reset form and update views
            this.taskForm.description = 'Slicing Lemons'; // Reset select
            this.taskForm.customDescription = ''; // Clear custom input
            this.taskForm.repeatDays = 1; // Reset repeat days
            document.getElementById('custom-task-input-container').style.display = 'none';

            this.renderHomePage();
            this.renderMyTasks();
            this.renderAdminAssignedTasks();
            this.renderAdminTaskOverview();
        },
        renderAdminAssignedShifts() {
            if (!this.isCurrentUserAdmin()) { this.assignedShifts = []; return; }
            const staffName = this.assignedShiftsView.staffName;
            const date = this.assignedShiftsView.date;
            
            if (!staffName || !date) {
                this.assignedShifts = [];
                return;
            }

            const shift = this.rota[date]?.[staffName];
            this.assignedShifts = shift ? [{ name: staffName, type: shift, date: date }] : [];
        },
        renderAdminAssignedTasks() {
            if (!this.isCurrentUserAdmin()) { this.assignedTasks = []; return; }
            const staffName = this.assignedTasksView.staffName;
            const date = this.assignedTasksView.date;

            if (!staffName || !date) {
                this.assignedTasks = [];
                return;
            }

            const tasks = this.dailyTasks[date]?.[staffName] || [];
            this.assignedTasks = tasks.map(task => ({ name: task }));
        },
        renderAdminShiftAttendance() {
            if (!this.isCurrentUserAdmin()) { this.attendanceList = []; return; }
            const selectedDate = this.attendanceView.date;
            if (!selectedDate) {
                this.attendanceList = [];
                return;
            }

            const dailyClockData = this.clockIns[selectedDate] || {};
            this.attendanceList = this.staff.map(member => {
                const clockData = dailyClockData[member.name];
                let statusText = 'Not Clocked In';
                let status = 'Not Clocked In';
                if (clockData && clockData.in) {
                    statusText = `Clocked In: ${this.formatTimestampToTime(clockData.in)}`;
                    status = 'Clocked In';
                    if (clockData.out) {
                        statusText += `, Clocked Out: ${this.formatTimestampToTime(clockData.out)}`;
                        status = 'Clocked Out'; // More specific status
                    } else {
                        statusText += ` (Still Clocked In)`;
                    }
                }
                return { name: member.name, statusText, status };
            });
        },
        renderAdminTaskOverview() {
            if (!this.isCurrentUserAdmin()) { this.taskOverviewList = []; return; }
            const selectedDate = this.taskOverviewView.date;
            const filterStatus = this.taskOverviewView.statusFilter;

            if (!selectedDate) {
                this.taskOverviewList = [];
                return;
            }

            let overviewTasks = [];
            const tasksForDate = this.dailyTasks[selectedDate] || {};
            const completedForDate = this.completedTasks[selectedDate] || {};

            this.staff.forEach(member => {
                const tasks = tasksForDate[member.name] || [];
                const completed = completedForDate[member.name] || {};

                tasks.forEach(taskName => {
                    const completionData = completed[taskName];
                    const isTaskCompleted = !!completionData;
                    const timestamp = typeof completionData === 'object' ? completionData.timestamp : completionData;
                    const imageName = typeof completionData === 'object' ? completionData.imageName : null;

                    let status = '';
                    let statusText = '';

                    if (isTaskCompleted) {
                        status = 'completed';
                        statusText = 'Completed';
                    } else {
                        if (this.isPastEndOfDay(selectedDate)) {
                            status = 'overdue';
                            statusText = 'Overdue';
                        } else {
                            status = 'pending';
                            statusText = 'Pending';
                        }
                    }

                    if (filterStatus === 'all' || filterStatus === status) {
                        overviewTasks.push({
                            staffName: member.name,
                            taskName: taskName,
                            status: status,
                            statusText: statusText,
                            timestamp: timestamp ? this.formatTimestampToTime(timestamp) : '',
                            imageName: imageName
                        });
                    }
                });
            });
            this.taskOverviewList = overviewTasks.sort((a,b) => a.staffName.localeCompare(b.staffName)); // Sort by staff name
        },
        deleteAdminItem(type, staffName, date, taskName = null) {
            if (!this.isCurrentUserAdmin()) { alert('Permission denied.'); return; }

            if (type === 'task') {
                if (confirm(`Are you sure you want to delete task "${taskName}" for ${staffName} on ${date}?`)) {
                    if (this.dailyTasks[date] && this.dailyTasks[date][staffName]) {
                        this.dailyTasks[date][staffName] = this.dailyTasks[date][staffName].filter(t => t !== taskName);
                        if (this.dailyTasks[date][staffName].length === 0) delete this.dailyTasks[date][staffName];
                        if (Object.keys(this.dailyTasks[date]).length === 0) delete this.dailyTasks[date];
                        this.saveData('dailyTasks', this.dailyTasks);

                        // Also remove from completed tasks if it was completed
                        if (this.completedTasks[date] && this.completedTasks[date][staffName] && this.completedTasks[date][staffName][taskName]) {
                            delete this.completedTasks[date][staffName][taskName];
                            if (Object.keys(this.completedTasks[date][staffName]).length === 0) delete this.completedTasks[date][staffName];
                            if (Object.keys(this.completedTasks[date]).length === 0) delete this.completedTasks[date];
                            this.saveData('completedTasks', this.completedTasks);
                        }
                        alert('Task deleted successfully.');
                    }
                }
            } else if (type === 'shift') {
                if (confirm(`Are you sure you want to delete the shift for ${staffName} on ${date}?`)) {
                    if (this.rota[date] && this.rota[date][staffName]) {
                        delete this.rota[date][staffName];
                        if (Object.keys(this.rota[date]).length === 0) delete this.rota[date];
                        this.saveData('rota', this.rota);
                        alert('Shift deleted successfully.');
                    }
                }
            }
            // Re-render relevant parts after deletion
            this.renderAdminAssignedShifts();
            this.renderAdminAssignedTasks();
            this.renderWeeklyRota();
            this.renderCalendar();
            this.renderHomePage();
            this.renderAdminTaskOverview();
        },

        // --- Calendar Navigation ---
        goToPrevMonth() {
            this.currentCalendarDate = new Date(this.currentCalendarDate.setMonth(this.currentCalendarDate.getMonth() - 1));
        },
        goToNextMonth() {
            this.currentCalendarDate = new Date(this.currentCalendarDate.setMonth(this.currentCalendarDate.getMonth() + 1));
        }
      }
    }
  </script>
</body>
</html>
