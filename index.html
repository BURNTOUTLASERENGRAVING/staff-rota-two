<!DOCTYPE html>
<html lang="en" x-data="app()" x-cloak>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Staff Rota & Tasks</title>
  <!-- Alpine.js for interactivity -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <script>
    function app() {
      return {
        staff: [],
        user: null,
        view: 'home',
        rota: {},
        dailyTasks: {},
        completedTasks: {},
        clockIns: {},
        messageBoard: [],
        isAdminMode: false,
        currentCalendarDate: new Date(),
        calendarRoleFilter: 'all',
        shiftForm: { staffName: '', date: '', type: '', customType: '', repeatDays: 1 },
        taskForm: { staffName: '', date: '', description: '', customDescription: '', repeatDays: 1 },
        assignedShiftsView: { staffName: '', date: '' },
        assignedShifts: [],
        assignedTasksView: { staffName: '', date: '' },
        assignedTasks: [],
        attendanceView: { date: '' },
        attendanceList: [],
        taskOverviewView: { date: '', statusFilter: 'all' },
        taskOverviewList: [],
        newMessageText: '',

        get todayFormatted() {
          const d = new Date(); return this.getFormattedDate(d);
        },
        get currentDayInfo() {
          const d = new Date(); return this.getDisplayDate(d);
        },
        get currentCalendarMonthYear() {
          return this.currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        },
        get isClockedIn() {
          const rec = this.clockIns[this.todayFormatted]?.[this.user?.name];
          return rec?.in && !rec.out;
        },
        get clockStatusMessage() {
          if (!this.user) return 'Please log in.';
          const rec = this.clockIns[this.todayFormatted]?.[this.user.name] || {};
          if (rec.in && !rec.out) return `You are clocked in since ${this.formatTimestampToTime(rec.in)}`;
          if (rec.in && rec.out) return `Clocked in: ${this.formatTimestampToTime(rec.in)}, Clocked out: ${this.formatTimestampToTime(rec.out)}`;
          return 'You are not clocked in for today.';
        },
        get clockButtonText() {
          return this.isClockedIn ? 'Clock Out' : 'Clock In';
        },
        get homeTasks() {
          if (!this.user) return [];
          const tasks = this.dailyTasks[this.todayFormatted]?.[this.user.name] || [];
          const comp = this.completedTasks[this.todayFormatted]?.[this.user.name] || {};
          return tasks.map(t => ({ name: t, status: comp[t] ? 'completed' : 'pending' }));
        },
        get myTasks() {
          if (!this.user) return [];
          const tasks = this.dailyTasks[this.todayFormatted]?.[this.user.name] || [];
          const comp = this.completedTasks[this.todayFormatted]?.[this.user.name] || {};
          return tasks.map(name => {
            const data = comp[name];
            const done = !!data;
            const ts = done && typeof data === 'object' ? data.timestamp : data;
            const img = done && typeof data === 'object' ? data.imageName : null;
            const status = done ? 'completed' : (this.isPastEndOfDay(this.todayFormatted) ? 'incomplete' : 'pending');
            return { name, status, timestampDisplay: ts ? this.formatTimestampToTime(ts) : '', imageName: img };
          });
        },
        get weeklyRota() {
          const days = this.getWeekDays(new Date());
          return days.map(day => {
            const date = this.getFormattedDate(day);
            const dayRota = this.rota[date] || {};
            const shifts = this.staff.filter(m => {
              if (this.user && !this.isCurrentUserAdmin()) {
                if (this.user.role === 'FOH' && m.role === 'BOH') return false;
                if (this.user.role === 'BOH' && m.role === 'FOH') return false;
              }
              return true;
            }).sort((a,b)=>( {FOH:1,BOH:2,Admin:3}[a.role] - {FOH:1,BOH:2,Admin:3}[b.role] || a.name.localeCompare(b.name) ))
              .map(m=>({ name: m.name, role: m.role, shift: dayRota[m.name]||'Off' }));
            return { date, displayDate: this.getDisplayDate(day), shifts };
          });
        },
        get calendarDays() {
          const year = this.currentCalendarDate.getFullYear();
          const month = this.currentCalendarDate.getMonth();
          const first = new Date(year, month, 1);
          const last = new Date(year, month+1,0);
          const blanks = (first.getDay()+6)%7;
          const arr = [];
          for(let i=0;i<blanks;i++) arr.push({ date:null, dayNumber:'', currentMonth:false, isToday:false, shifts:[] });
          const today = this.getFormattedDate(new Date());
          for(let d=1;d<=last.getDate();d++){
            const dt = new Date(year,month,d);
            const fmt = this.getFormattedDate(dt);
            const isToday = fmt === today;
            const dayRota = this.rota[fmt]||{};
            const shifts = this.staff.filter(m=>{
              if (this.user && !this.isCurrentUserAdmin()) {
                if (this.user.role==='FOH'&&m.role==='BOH') return false;
                if (this.user.role==='BOH'&&m.role==='FOH') return false;
              }
              return this.calendarRoleFilter==='all'||m.role===this.calendarRoleFilter;
            }).sort((a,b)=>a.name.localeCompare(b.name))
              .map(m=>({ name:m.name, role:m.role, type: dayRota[m.name]||'Off' }))
              .filter(s=>s.type!=='Off');
            arr.push({ date:fmt, dayNumber:d, currentMonth:true, isToday, shifts });
          }
          return arr;
        },
        get workingStaff() {
          const fmt = this.getFormattedDate(new Date());
          const dayRota = this.rota[fmt]||{};
          const foh=[],boh=[],adm=[];
          this.staff.filter(m=>{
            if(this.user && !this.isCurrentUserAdmin()){
              if(this.user.role==='FOH'&&m.role==='BOH') return false;
              if(this.user.role==='BOH'&&m.role==='FOH') return false;
            }
            return true;
          }).forEach(m=>{
            const sh = dayRota[m.name];
            if(sh&&sh!=='Off'){
              const itm = { name:m.name, role:m.role, icon:m.icon, shift:sh };
              if(m.role==='FOH') foh.push(itm);
              else if(m.role==='BOH') boh.push(itm);
              else adm.push(itm);
            }
          });
          return { foh, boh, admin:adm };
        },

        loadData(k){try{return JSON.parse(localStorage.getItem(k))}catch{return null}},
        saveData(k,d){try{localStorage.setItem(k,JSON.stringify(d))}catch{alert('LocalStorage full');}},
        getFormattedDate(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');return`${y}-${m}-${da}`;},
        formatTimestampToTime(ts){return ts?new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}):'N/A';},
        getDisplayDate(d){return d.toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'})},
        addDays(d,n){const dt=new Date(d);dt.setDate(dt.getDate()+n);return dt},
        isPastEndOfDay(s){const d=new Date(s);d.setHours(23,59,59,999);const now=new Date();now.setHours(0,0,0,0);return d<now},
        isCurrentUserAdmin(){return this.user?.role==='Admin'},
        getWeekDays(start){const day=start.getDay(),mon=new Date(start.getTime()-((day+6)%7)*86400000);return Array.from({length:7},(_,i)=>new Date(mon.getTime()+i*86400000));},
        cleanupOldData(){const cutoff=Date.now()-86400000;this.messageBoard=this.messageBoard.filter(m=>m.timestamp>cutoff);this.saveData('messageBoard',this.messageBoard);const ct={};for(const date in this.completedTasks){if(this.isPastEndOfDay(date)){const pd={};for(const u in this.completedTasks[date]){const keep={};for(const t in this.completedTasks[date][u]){const ts= typeof this.completedTasks[date][u][t]==='object'?this.completedTasks[date][u][t].timestamp:this.completedTasks[date][u][t];if(ts>cutoff) keep[t]=this.completedTasks[date][u][t];}if(Object.keys(keep).length)pd[u]=keep;}if(Object.keys(pd).length)ct[date]=pd;}else ct[date]=this.completedTasks[date];}this.completedTasks=ct;this.saveData('completedTasks',this.completedTasks);},

        initializeAlpineApp(){
          this.staff = this.loadData('staffMembers') || [
            {name:'Jill',role:'FOH',icon:'💁‍♀️'},{name:'Alice',role:'FOH',icon:'💁‍♀️'},{name:'Callum',role:'FOH',icon:'💁‍♀️'},{name:'Jess',role:'FOH',icon:'💁‍♀️'},
            {name:'Danny',role:'BOH',icon:'👩‍🍳'},{name:'Neil',role:'BOH',icon:'👩‍🍳'},{name:'Terry',role:'BOH',icon:'👴'},{name:'Richard',role:'BOH',icon:'👩‍🍳'},
            {name:'Johnny',role:'Admin',icon:'🤵'},{name:'Lyndsey',role:'Admin',icon:'🤵'},{name:'Collin',role:'Admin',icon:'🤵'}
          ];
          this.rota = this.loadData('rota')||{};
          this.dailyTasks = this.loadData('dailyTasks')||{};
          this.completedTasks = this.loadData('completedTasks')||{};
          this.clockIns = this.loadData('clockIns')||{};
          this.messageBoard = this.loadData('messageBoard')||[];

          const uName = this.loadData('currentUserName');
          const uRole = this.loadData('currentUserRole');
          if(uName&&uRole){this.user=this.staff.find(s=>s.name===uName&&s.role===uRole)||null; if(this.user.role==='Admin')this.isAdminMode=this.loadData('isAdminMode')||false;}

          if(this.user){this.view='home';this.cleanupOldData();}else{this.user=null;this.view='landing';}

          const today=this.getFormattedDate(new Date());
          this.shiftForm.date=this.taskForm.date=this.assignedShiftsView.date=this.assignedTasksView.date=this.attendanceView.date=this.taskOverviewView.date=today;
          this.shiftForm.staffName=this.taskForm.staffName=this.assignedShiftsView.staffName=this.assignedTasksView.staffName=this.user?.name||this.staff[0].name;
        },

        login(m){this.user=m;this.saveData('currentUserName',m.name);this.saveData('currentUserRole',m.role);this.isAdminMode=false;this.saveData('isAdminMode',false);this.view='home';this.cleanupOldData();},
        logout(){this.user=null;this.isAdminMode=false;this.saveData('currentUserName',null);this.saveData('currentUserRole',null);this.saveData('isAdminMode',false);},
        toggleAdminMode(){if(!this.isCurrentUserAdmin()){alert('Permission denied');return;}this.isAdminMode=!this.isAdminMode;this.saveData('isAdminMode',this.isAdminMode);this.view=this.isAdminMode?'admin':'home';},
        // Additional methods omitted for brevity
      };
    }

    document.addEventListener('alpine:init',()=>{
      Alpine.data('app',app);
    });
  </script>

  <style>
    [x-cloak] { display: none !important; }
    /* All existing custom styles here unchanged... */
  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
  <!-- Landing -->
  <div x-show="!user" x-cloak class="min-h-screen flex items-center justify-center">
    <h1>Welcome, Staff!</h1>
    <!-- Landing content -->
  </div>
  <!-- App Container -->
  <div x-show="user" x-cloak class="min-h-screen flex flex-col">
    <header class="p-4 bg-gray-900 text-white flex justify-between items-center">
      <h2 class="text-xl">Staff Rota & Tasks</h2>
      <div>
        <span x-text="user.name + ' (' + user.role + ')'" class="mr-4"></span>
        <button @click="logout()">Sign Out</button>
      </div>
    </header>
    <nav class="bg-gray-800 p-2 text-white flex space-x-2">
      <button @click="view='home'" :class="view==='home'? 'bg-purple-600':''">Home</button>
      <button @click="view='tasks'" :class="view==='tasks'? 'bg-purple-600':''">My Tasks</button>
      <button @click="view='rota'" :class="view==='rota'? 'bg-purple-600':''">Weekly Rota</button>
      <button @click="view='calendar'" :class="view==='calendar'? 'bg-purple-600':''">Calendar</button>
      <template x-if="isCurrentUserAdmin()">
        <button @click="view='admin'" :class="view==='admin'? 'bg-purple-600':''">Admin</button>
      </template>
    </nav>
    <main class="flex-1 overflow-auto p-6">
      <!-- Sections for each view using x-show and Alpine reactivity -->
    </main>
    <footer class="p-4 bg-gray-200 text-center text-gray-700">
      &copy; <span x-text="new Date().getFullYear()"></span> Staff Rota & Tasks
    </footer>
  </div>
</body>
</html>
